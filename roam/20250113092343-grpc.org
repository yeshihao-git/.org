:PROPERTIES:
:ID:       a5c426e4-365b-447d-89f3-eddc9c517a01
:END:
#+title: grpc
#+filetags: rpc

* grpc
- grpc :: googleå¼€æºçš„é«˜æ€§èƒ½ RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰æ¡†æ¶ ï¼Œä½¿å¾—å¯¹æœåŠ¡å™¨ä¸Šæ–¹æ³•çš„è°ƒç”¨å°±åƒåœ¨æœ¬åœ°ä¸€æ ·ï¼ˆå¼€å‘è€…åªéœ€å…³æ³¨ä¸šåŠ¡é€»è¾‘æ— éœ€å…³æ³¨åº•å±‚ç½‘ç»œé€šä¿¡ï¼‰ï¼Œç”¨äºæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€
  1. åŸºäº [[id:98a7eb31-261b-4c66-9144-cb9adb4cf455][HTTP/2.0]] å’Œ [[id:2d06cf5c-702c-40bd-ad17-d1458156b2fa][Protocol Buffers]]

*ä½¿ç”¨æµç¨‹* ï¼š
1. .protoæ–‡ä»¶ä¸­å®šä¹‰ï¼šmessageæ ¼å¼ã€æœåŠ¡ã€æœåŠ¡å†…rpcæ–¹æ³•ï¼ˆ4ç§rpcç±»å‹[fn:1]ï¼‰
2. protocã€grpcæ’ä»¶ï¼šç”Ÿæˆ.pbã€.grpc.pbæ–‡ä»¶
   - .pb.hå’Œ.pb.cc           :: messageçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç 
   - .grpc.pb.hå’Œ.grpc.pb.cc :: æœåŠ¡å’Œå­˜æ ¹çš„æ¡†æ¶ä»£ç 
3. grpcå®¢æˆ·ç«¯ï¼šç”Ÿæˆ Channelï¼Œåœ¨ Channel åŸºç¡€ä¸Šç”Ÿæˆ Stubï¼ˆå­˜æ ¹ï¼‰ï¼Œé€šè¿‡ Stub è°ƒç”¨ grpcæœåŠ¡ç«¯æ–¹æ³•
4. grpcæœåŠ¡ç«¯ï¼š
   1) æœåŠ¡å®ç°ç±» ç»§æ‰¿ grpc.pb æ–‡ä»¶ä¸­çš„ Serviceç±»ï¼Œé‡å†™æ‰€æœ‰rpcæ–¹æ³•
      #+begin_example cpp
      class ChatServiceImpl final: public ChatService::Service { /*...*/ }
      #+end_example
   2) å¯åŠ¨æœåŠ¡ï¼šServerBuilderå·¥å‚ç±» é…ç½®ç›‘å¬ç«¯å£ å¹¶ æ³¨å†ŒæœåŠ¡å®ç°ç±»ï¼Œå¯åŠ¨
      #+begin_example cpp
      chatserver::ChatServiceImpl service;
		  grpc::ServerBuilder builder;
		  builder.AddListeningPort(server_address, grpc::InsecureServerCredentials());
		  builder.RegisterService(&service);
		  std::unique_ptr<grpc::Server> server(builder.BuildAndStart());
		  std::thread  grpc_server_thread([&server]() {
			  server->Wait();
			});
      #+end_example

ğŸ“ [[https://grpc.io/docs/languages/cpp/basics/][grpcå®˜ç½‘:cpp]] [[https://grpc.io/docs/what-is-grpc/core-concepts/][grpcå®˜ç½‘:æ ¸å¿ƒæ¦‚å¿µ]]


** ç¼–è¯‘grpc
:PROPERTIES:
:ID:       d85b1e53-a8a3-4718-8cdb-eec21968ff49
:END:
1. [[id:54642b64-644b-4f5a-977f-572f75973445][gitèµ°ä»£ç†]]
2. git clone -b <é€‰æ‹©Tag> https://github.com/grpc/grpc
3. cd grpc
4. git submodule update --init
5. mkdir -p cmake/build
6. cd cmake/build
7. cmake -DCMAKE_CXX_STANDARD=17 ../..
8. make -j$(nproc)
9. make install
10. å®‰è£…åˆ° /usr/local/binï¼Œæœ‰äº›ç¨‹åºåœ¨ /usr/binä¸‹å¯»æ‰¾ -> è§£å†³æ–¹å¼ï¼š[[id:bb654a41-440c-468d-999c-fd8470e4f15c][è½¯è¿æ¥]]


* Protocol Buffers
:PROPERTIES:
:ID:       2d06cf5c-702c-40bd-ad17-d1458156b2fa
:END:
- Protocol Buffers :: googleå¼€å‘çš„ =è¯­è¨€æ— å…³= ã€ =å¹³å°æ— å…³= çš„ *ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–åè®®* ï¼Œä½“ç§¯æ›´å°ã€è§£ææ›´å¿«ã€ä½†å¯è¯»æ€§å·®ï¼ˆç›¸æ¯” JSONï¼‰ï¼›å®šä¹‰åœ¨ .protoæ–‡ä»¶ï¼Œä½¿ç”¨ protoc ç¼–è¯‘ç”Ÿæˆ .pb.hã€.pb.cc æ–‡ä»¶

*.pbæ–‡ä»¶ä¸­çš„æ–¹æ³•* ï¼š
1. åŸºæœ¬å­—æ®µ           ï¼šget()ã€set_xxx()ã€has_xxx()ã€clear_xxx() [fn:2]
2. repeatedä¿®é¥°çš„å­—æ®µ ï¼šxxx_size()ã€xxx(index)ã€add_xxx()ã€mutable_xxx() [fn:3]
   - repeatedä¿®é¥°çš„å­—æ®µ :: åŒ…å«å¤šä¸ªç›¸åŒç±»å‹çš„å€¼ï¼Œç±»ä¼¼"æ•°ç»„"

ğŸ“ [[https://protobuf.dev/getting-started/cpptutorial/][Protocol Bufferså®˜ç½‘]]


** protoc
- protoc :: ç¼–è¯‘å™¨ï¼Œç”¨äºå°†ç¬¦åˆ [[id:2d06cf5c-702c-40bd-ad17-d1458156b2fa][Protocol Buffers]] åè®®çš„ .protoæ–‡ä»¶ ç¼–è¯‘æˆ æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ä»£ç ï¼ˆä¸åŒè¯­è¨€çš„è½¬æ¢å·¥ä½œç”±å¯¹åº”çš„è¯­è¨€æ’ä»¶å®ç°ï¼‰


*** protocç”Ÿæˆcppä»£ç 
:PROPERTIES:
:ID:       bb79e103-432f-47e1-8ec7-1b109338704d
:END:
- ç”Ÿæˆ[[id:8ab4df56-e11f-42b8-87f8-4daa2fd045db][cpp]]ä»£ç  :: --cpp_out=./outï¼šæŒ‡å®šè¾“å‡ºç›®å½• ./outï¼Œä¼šç”Ÿæˆ example.pb.h å’Œ example.pb.cc
  #+begin_src bash
  protoc --cpp_out=./out example.proto
  #+end_src
- ç”Ÿæˆ[[id:a5c426e4-365b-447d-89f3-eddc9c517a01][gRPC]]ä»£ç  :: --grpc_out ç”Ÿæˆ example.grpc.pb.h å’Œ example.grpc.pb.cc
  #+begin_src bash
  protoc --grpc_out=./out --plugin=protoc-gen-grpc=`which grpc_cpp_plugin` example.proto
  #+end_src



* absl
:PROPERTIES:
:ID:       3c06d3c1-83d0-459a-b6a6-2a27ced7a00d
:ROAM_ALIASES: abseil
:END:
- absl :: ï¼ˆabseilï¼‰googleå¼€æºçš„ C++ åŸºç¡€åº“é›†åˆ
  1. ä¸º protobuf å’Œ grpc æä¾›é«˜æ€§èƒ½çš„ C++ç»„ä»¶

** abslé“¾æ¥å¤±è´¥é—®é¢˜
:PROPERTIES:
:ID:       52cf4505-b22b-4664-91b9-264fc1e8ac40
:END:
(æˆ‘çš„è§£å†³æ–¹å¼) [[id:c651b8b0-bc76-451d-acac-0ea55329f0e8][cmake]] ä¸­å°†ç¼–è¯‘å™¨ clang++ æ”¹æˆ [[id:3aa872a4-290a-4fc8-8e37-add919e44822][g++]]

ğŸ“ [[https://blog.csdn.net/witton/article/details/144182568][MSYS2 MinGW64ä½¿ç”¨Protobufæ–°ç‰ˆæœ¬è¸©å‘]]


** ğŸ–¼ abseilã€protobufå’Œgrpcåä½œå…³ç³» :ATTACH:
:PROPERTIES:
:ID:       e9b3a6d1-0ec1-4891-935c-8a90d3e54259
:END:
[[attachment:_20250430_180211screenshot.png]]





* Footnotes

[fn:1]
#+begin_example cpp
// NOTE ä¸€å…ƒrpcæ–¹æ³•  ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªå“åº”
rpc SayHello(HelloRequest) returns (HelloResponse);
// NOTE æœåŠ¡å™¨æµå¼RPCï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªæµï¼ˆä¸€ç³»åˆ—æ¶ˆæ¯ï¼‰
rpc LotsOfReplies(HelloRequest) returns (stream HelloResponse);
// NOTE å®¢æˆ·ç«¯æµå¼RPCï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæµï¼ŒæœåŠ¡å™¨è¿”å›ä¸€ä¸ªå“åº”
rpc LotsOfGreetings(stream HelloRequest) returns (HelloResponse);
// NOTE åŒå‘æµå¼RPC  ï¼šåŒå‘æ”¶å‘æµ
rpc BidiHello(stream HelloRequest) returns (stream HelloResponse);
#+end_example

[fn:2]
#+begin_example cpp
/* .protoå®šä¹‰
message User {
  int32 id = 1;
  string name = 2;
  bool is_active = 3;
}
*/

// è·å–å­—æ®µå€¼
int32_t id() const;                  // è¿”å› id çš„å€¼
const std::string& name() const;     // è¿”å› name çš„å€¼ï¼ˆstring ç±»å‹è¿”å›å¼•ç”¨ï¼‰
bool is_active() const;              // è¿”å› is_active çš„å€¼

// è®¾ç½®å­—æ®µå€¼
void set_id(int32_t value);          // è®¾ç½® id çš„å€¼
void set_name(const std::string& value);  // è®¾ç½® name çš„å€¼
void set_is_active(bool value);      // è®¾ç½® is_active çš„å€¼

// æ¸…ç©ºå­—æ®µï¼ˆæ¢å¤é»˜è®¤å€¼ï¼‰
void clear_id();
void clear_name();
void clear_is_active();

// åˆ¤æ–­å­—æ®µæ˜¯å¦è¢«æ˜¾å¼è®¾ç½®ï¼ˆéé»˜è®¤å€¼ï¼‰
bool has_id() const;
bool has_name() const;
bool has_is_active() const;
#+end_example

[fn:3]
#+begin_example cpp
/* .protoå®šä¹‰
message Chat {
  repeated string messages = 1;
  repeated User members = 2;  // åµŒå¥—æ¶ˆæ¯ç±»å‹
}
*/

// 1. è·å–åˆ—è¡¨ä¿¡æ¯
int messages_size() const;                  // è·å– messages åˆ—è¡¨é•¿åº¦
int members_size() const;                   // è·å– members åˆ—è¡¨é•¿åº¦

// 2. è®¿é—®åˆ—è¡¨å…ƒç´ ï¼ˆé€šè¿‡ç´¢å¼•ï¼‰
const std::string& messages(int index) const;  // è·å– messages ç¬¬ index ä¸ªå…ƒç´ 
const User& members(int index) const;          // è·å– members ç¬¬ index ä¸ªå…ƒç´ 

// 3. æ·»åŠ å…ƒç´ ï¼ˆæ¨èæ–¹å¼ï¼‰
std::string* add_messages();                 // æ–°å¢ä¸€ä¸ªç©ºå­—ç¬¦ä¸²åˆ° messagesï¼Œè¿”å›æŒ‡é’ˆ
User* add_members();                         // æ–°å¢ä¸€ä¸ªç©º User åˆ° membersï¼Œè¿”å›æŒ‡é’ˆ

// 4. ç›´æ¥æ“ä½œåº•å±‚å®¹å™¨ï¼ˆè¿”å› vector ç±»ä¼¼ç‰©çš„å¼•ç”¨ï¼‰
google::protobuf::RepeatedPtrField<std::string>* mutable_messages();
google::protobuf::RepeatedPtrField<User>* mutable_members();

// ç¤ºä¾‹ï¼šé€šè¿‡å®¹å™¨æ“ä½œ
auto* members = chat.mutable_members();
User new_user;
new_user.set_id(100);
members->Add()->CopyFrom(new_user);  // å¤åˆ¶ä¸€ä¸ª User åˆ°åˆ—è¡¨

// 5. æ¸…ç©ºåˆ—è¡¨
void clear_messages();
void clear_members();
#+end_example
