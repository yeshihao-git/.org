:PROPERTIES:
:ID:       a3778673-5028-4637-b8f2-85b1bf798587
:END:
#+title: é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§
#+filetags: cpp

* é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§
- é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ ::
  1. [[id:0738d211-b694-4401-b3d8-ce700fa52f25][å°è£…]]
  2. [[id:4dd617ab-639b-4748-a543-7a65ddf02913][ç»§æ‰¿]]
  3. [[id:1f4d0779-e20a-431e-b16a-a799e7f7b1ac][å¤šæ€]]

** å°è£…
:PROPERTIES:
:ID:       0738d211-b694-4401-b3d8-ce700fa52f25
:END:
- å°è£… :: å°†æ•°æ®å’Œæ–¹æ³•ç»‘å®šåœ¨ä¸€èµ·ï¼›éšè—ç±»å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œåªæš´éœ²å¿…è¦çš„æ¥å£


** ç»§æ‰¿
:PROPERTIES:
:ID:       4dd617ab-639b-4748-a543-7a65ddf02913
:END:
- ç»§æ‰¿ :: æ´¾ç”Ÿç±»ç»§æ‰¿åŸºç±»çš„æ•°æ®å’Œæ–¹æ³•ï¼Œå®ç° *ä»£ç å¤ç”¨* ï¼ŒåŒæ—¶åœ¨æ­¤åŸºç¡€ä¸Šèƒ½è¿›è¡Œ *æ‰©å±•*
  1. =is-a= çš„å…³ç³»ï¼ˆå¯ä½¿ç”¨åŸºç±»æŒ‡é’ˆ/å¼•ç”¨ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œè¿™æ ·å°±èƒ½ä¼ å…¥ç»§æ‰¿ä½“ç³»ä¸­çš„ä»»ä½•å¯¹è±¡ï¼Œæ›´çµæ´»ï¼‰ï¼Œç»„åˆæ˜¯ =has-a= çš„å…³ç³»
  2. æ´¾ç”Ÿç±» *æ„é€ é¡ºåº* ï¼šåŸºç±» -> æ´¾ç”Ÿç±»ï¼ˆé”€æ¯ç›¸åï¼‰ [fn:1]
  3. *ç»§æ‰¿æƒé™* + åŸºç±»è®¿é—®é™å®šç¬¦ = åŸºç±»æˆå‘˜è®¿é—®é™å®šç¬¦
     |--------------------+-------------------+-----------------+-------------------|
     | åŸºç±»ä¸­çš„è®¿é—®é™å®šç¬¦ | publicç»§æ‰¿        | privateç»§æ‰¿     | protectedç»§æ‰¿     |
     |--------------------+-------------------+-----------------+-------------------|
     | Publicï¼ˆå…¬æœ‰ï¼‰     | Publicï¼ˆå…¬æœ‰ï¼‰    | Privateï¼ˆç§æœ‰ï¼‰ | Protectedï¼ˆä¿æŠ¤ï¼‰ |
     | Protectedï¼ˆä¿æŠ¤ï¼‰  | Protectedï¼ˆä¿æŠ¤ï¼‰ | Privateï¼ˆç§æœ‰ï¼‰ | Protectedï¼ˆä¿æŠ¤ï¼‰ |
     | Privateï¼ˆç§æœ‰ï¼‰    | ä¸å¯è®¿é—®          | ä¸å¯è®¿é—®        | ä¸å¯è®¿é—®          |
     |--------------------+-------------------+-----------------+-------------------|
  4. [[id:43588f09-c7d7-4c7a-9e13-026c2dda6441][usingå£°æ˜]] å¯ä»¥ [fn:2]
     1) æ›´æ”¹ ç»§æ‰¿æˆå‘˜çš„è®¿é—®æƒé™
     2) å°†çˆ¶ç±»çš„å‡½æ•°åŠ å…¥æ´¾ç”Ÿç±»è¿›è¡Œ [[id:a545a441-471f-45d4-8a7b-30767486357a][å‡½æ•°é‡è½½]]
  5. åœ¨æ´¾ç”Ÿç±» *æ·»åŠ æ–°åŠŸèƒ½* ï¼šç»§æ‰¿ [fn:3]
     #+name: why
     #+begin_comment
     ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ä»£ç åº“ï¼Œæƒ³æ‰©å……åŠŸèƒ½ï¼Œæ— æ³•ç›´æ¥åœ¨ä»£ç åº“ä¸­å†™åŠŸèƒ½ï¼Œä¸”åè¾¹ç¬¬ä¸‰æ–¹æ›´æ–°äº†ä»£ç åº“ï¼Œå¯èƒ½å‡ºé—®é¢˜ -> é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ·»åŠ åŠŸèƒ½
     #+end_comment
  6. æ´¾ç”Ÿç±» *è®¿é—®åŸºç±»å‡½æ•°*
     1) è®¿é—®åŸºç±»åŒåå‡½æ•°ï¼šåŠ åŸºç±»ä½œç”¨åŸŸé™å®šç¬¦ =<åŸºç±»>::<åŸºç±»åŒåå‡½æ•°>= [fn:4]
     2) è®¿é—®åŸºç±»å‹å…ƒå‡½æ•°ï¼šä½¿ç”¨ =static_cast= è½¬ä¸ºåŸºç±»åè°ƒç”¨ [fn:5]ï¼ˆå‹å…ƒå‡½æ•°ä¸æ˜¯åŸºç±»æˆå‘˜ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ åŸºç±»ä½œç”¨åŸŸé™å®šç¬¦ï¼‰
  7. æ´¾ç”Ÿç±» *é‡å®šä¹‰æˆå‘˜å‡½æ•°* ï¼Œé€šè¿‡æ´¾ç”Ÿç±»è°ƒç”¨çš„æ˜¯æ´¾ç”Ÿç±»ç‰ˆæœ¬ [fn:6]
  8. æ³¨æ„ [[id:89b97115-840f-4c51-bbd3-957c58678145][å¯¹è±¡åˆ‡ç‰‡]] é—®é¢˜
  9. è§£å†³ *è±å½¢ç»§æ‰¿* é—®é¢˜ï¼š[[id:476d4abd-3c49-4cc4-bf1a-7e05a140485a][è™šåŸºç±»]]


*** å¯¹è±¡åˆ‡ç‰‡
:PROPERTIES:
:ID:       89b97115-840f-4c51-bbd3-957c58678145
:END:
- å¯¹è±¡åˆ‡ç‰‡ :: å°†æ´¾ç”Ÿç±»å¯¹è±¡èµ‹å€¼ç»™åŸºç±»å¯¹è±¡ï¼Œæ´¾ç”Ÿç±»å¯¹è±¡çš„åŸºç±»éƒ¨åˆ†è¢«å¤åˆ¶ï¼Œæ´¾ç”Ÿç±»éƒ¨åˆ†ä¸ä¼šã€‚å‘ç”Ÿåœºæ™¯ï¼š
  1. èµ‹å€¼ [fn:7]           --è§£å†³--> å¼•ç”¨
  2. å‡½æ•°å‚æ•°å€¼ä¼ é€’ [fn:8] --è§£å†³--> å¼•ç”¨
  3. std::vector [fn:9]    --è§£å†³--> æŒ‡é’ˆã€å¼•ç”¨


*** è™šåŸºç±»
:PROPERTIES:
:ID:       476d4abd-3c49-4cc4-bf1a-7e05a140485a
:END:
- è±å½¢ç»§æ‰¿ :: Bã€C ç»§æ‰¿ Aï¼ŒD ç»§æ‰¿ Bã€Cï¼Œå¯¼è‡´ D ä¸­åŒ…å« A ä¸­çš„å¤šä»½æˆå‘˜å˜é‡å‰¯æœ¬ï¼Œå¼•å‘æˆå‘˜å˜é‡ *è®¿é—®äºŒä¹‰æ€§* ã€ *å†…å­˜æµªè´¹* é—®é¢˜ -> ä½¿ç”¨è™šåŸºç±»åï¼Œæœ€æ´¾ç”Ÿç±»D ä¸­ æœ€åŸºç±»A æˆå‘˜å˜é‡åªæœ‰1ä»½ï¼Œé—®é¢˜è§£å†³

- è™šåŸºç±» :: æ´¾ç”Ÿç±»é€šè¿‡ =virtual= ä¿®é¥°çš„ç»§æ‰¿ ç»§æ‰¿åŸºç±»ï¼Œè¯¥åŸºç±»ä¸ºè™šåŸºç±»ï¼Œç”¨äºè§£å†³ â€œè±å½¢ç»§æ‰¿â€ é—®é¢˜ [fn:10]
  1. æœ€åŸºç±»çš„åˆ›å»ºç”±æœ€æ´¾ç”Ÿç±»è´Ÿè´£ [fn:11]
  2. æœ€æ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°ä¸­ *è™šåŸºç±»åœ¨éè™šåŸºç±»ä¹‹å‰åˆ›å»º* [fn:11]
  3. [[id:843fce83-7f40-43cc-a5e4-0df9b75b8ba7][è™šåŸºç±»åº•å±‚]]


**** è™šåŸºç±»åº•å±‚
:PROPERTIES:
:ID:       843fce83-7f40-43cc-a5e4-0df9b75b8ba7
:END:
*åº•å±‚* ï¼šæ¯ä¸ªè™šç»§æ‰¿ç±»ä¸­æœ‰ =vbptr= ï¼ˆè™šåŸºç±»æŒ‡é’ˆï¼‰ï¼ŒæŒ‡å‘ è™šåŸºç±»è¡¨ï¼Œè™šåŸºç±»è¡¨ä¸­è®°å½• Baseçš„åç§»é‡ï¼Œé€šè¿‡åç§»é‡å®šä½åˆ° Base
#+begin_src cpp
class Base {
public:
  int data {12};
};

class A: virtual public Base { }; // è™šç»§æ‰¿
class B: virtual public Base { };

class Derived: public A, public B { };
/*
Derivedå¯¹è±¡å†…å­˜ç»“æ„ï¼š
[ A::vbptr ]        -> æŒ‡å‘Açš„è™šåŸºç±»è¡¨ï¼ˆè®°å½•Baseçš„åç§»é‡ï¼‰
[ Açš„æˆå‘˜å˜é‡ ]
[ B::vbptr ]        -> æŒ‡å‘Bçš„è™šåŸºç±»è¡¨
[ Bçš„æˆå‘˜å˜é‡ ]
[ å”¯ä¸€Baseå­å¯¹è±¡ ]  -> è¢«Aå’ŒBå…±äº«
,*/
#+end_src
*è®¿é—®æµç¨‹* ï¼š
1. é€šè¿‡ A/B::vbptr æ‰¾åˆ°è™šåŸºç±»è¡¨ï¼Œè·å¾— Base çš„åç§»é‡ offset
2. è®¿é—® Derivedå¯¹è±¡åœ°å€ + offset å®šä½åˆ° Base::data


** å¤šæ€
:PROPERTIES:
:ID:       1f4d0779-e20a-431e-b16a-a799e7f7b1ac
:END:
- å¤šæ€ :: ä¸€ä¸ªæ¥å£ï¼ˆä½¿ç”¨è€…çœ‹åˆ°çš„åŠŸèƒ½å…¥å£ï¼‰ï¼Œå¤šç§å®ç°ï¼›åˆ†ä¸ºç¼–è¯‘æ—¶å¤šæ€ã€è¿è¡Œæ—¶å¤šæ€
  + ç¼–è¯‘æ—¶å¤šæ€ :: ç¼–è¯‘æ—¶è§£ææ¥å£ï¼Œå¹¶ç»‘å®šåˆ°å…·ä½“å®ç° -> [[id:a545a441-471f-45d4-8a7b-30767486357a][å‡½æ•°é‡è½½]]ã€æ¨¡æ¿
  + è¿è¡Œæ—¶å¤šæ€ :: è¿è¡Œæ—¶è§£ææ¥å£ï¼Œå¹¶ç»‘å®šåˆ°å…·ä½“å®ç° -> [[id:37d4f6e6-c9bd-4bcf-8f15-3cb6ef7a14f7][è™šå‡½æ•°]]
#+begin_comment
å‡½æ•°é‡è½½ï¼šå‡½æ•°åï¼ˆæ¥å£ï¼‰æ ¹æ®å‡½å‚ç¡®å®šï¼ˆè§£æã€ç»‘å®šï¼‰åŒ¹é…çš„å‡½æ•°ï¼ˆå®ç°ï¼‰
æ¨¡æ¿    ï¼šæ¨¡æ¿ï¼ˆæ¥å£ï¼‰æ ¹æ®ä¼ å…¥å‚æ•°ç¡®å®šï¼ˆè§£æã€ç»‘å®šï¼‰å®ä¾‹åŒ–å‡½æ•°/ç±»ï¼ˆå®ç°ï¼‰
è™šå‡½æ•°  ï¼šå‡½æ•°åï¼ˆæ¥å£ï¼‰æ ¹æ®è™šå‡½æ•°è¡¨ç¡®å®šï¼ˆè§£æã€ç»‘å®šï¼‰æœ€ç»ˆè°ƒç”¨å‡½æ•°ï¼ˆå®ç°ï¼‰
#+end_comment


*** è™šå‡½æ•°
:PROPERTIES:
:ID:       37d4f6e6-c9bd-4bcf-8f15-3cb6ef7a14f7
:END:
- è™šå‡½æ•° :: =virtual= å£°æ˜çš„æˆå‘˜å‡½æ•°ï¼Œå…è®¸æ´¾ç”Ÿç±» *é‡å†™* å…¶å®ç°ï¼Œå®ç° [[id:a3778673-5028-4637-b8f2-85b1bf798587][è¿è¡Œæ—¶å¤šæ€]]ï¼Œå…·ä½“æ¥è¯´ï¼šé€šè¿‡åŸºç±»çš„ *æŒ‡é’ˆæˆ–å¼•ç”¨* è°ƒç”¨è™šå‡½æ•°æ—¶ä¼šè°ƒç”¨ åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨ æŒ‡å‘æˆ–å¼•ç”¨çš„ç±»å¯¹è±¡çš„è™šå‡½æ•°ç‰ˆæœ¬ [fn:12]
  1. ä¸€ä¸ªå‡½æ•°æ˜¯ =virtual= ï¼Œåˆ™ *æ´¾ç”Ÿç±»ä¸­é‡å†™çš„å‡½æ•°éƒ½æ˜¯ =virtual= å‡½æ•°* ï¼ˆå³ä½¿æ²¡æœ‰æ˜¾å¼æ ‡è®°ï¼‰
  2. *åŸºç±» [[id:be44b0c2-d234-409f-b1a6-b447e365db37][ææ„å‡½æ•°]] åº”è®¾ç½®ä¸º =virtual= çš„* ï¼Œé˜²æ­¢ [[id:6782179f-792b-4eb6-807c-4f95aba88169][å†…å­˜æ³„æ¼]] [fn:13]
  3. ä½¿ç”¨åœºæ™¯ï¼šä½œä¸º *å‡½æ•°å‚æ•°* ä½¿ç”¨ [fn:14]
  4. ä½¿ç”¨ [[id:5da43f35-39b6-4d7e-9d04-3221a6a092e7][std::dynamic_cast]] è¿›è¡Œå‘ä¸‹è½¬å‹


**** è™šå‡½æ•°å®ç°
æœ‰è™šå‡½æ•°çš„ç±»ï¼ˆ =virtual= ï¼‰æœ‰ è™šå‡½æ•°è¡¨ã€è™šå‡½æ•°æŒ‡é’ˆï¼ˆ =*__vptr= ï¼‰ï¼Œå…¶æ´¾ç”Ÿç±»ä¹Ÿæœ‰è‡ªå·±çš„è™šå‡½æ•°è¡¨ï¼›
åœ¨ç±»å¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè™šå‡½æ•°æŒ‡é’ˆ æŒ‡å‘å¯¹åº”çš„è™šå‡½æ•°è¡¨ï¼ˆegï¼šæ´¾ç”Ÿç±»åˆ›å»ºæ—¶ï¼Œè™šå‡½æ•°è¡¨æŒ‡é’ˆæŒ‡å‘æ´¾ç”Ÿç±»çš„è™šå‡½æ•°è¡¨ï¼Œè¡¨å†…ä¼šç”¨æ‰é‡å†™ç‰ˆæœ¬çš„å‡½æ•°æŒ‡é’ˆæ›¿æ¢è¢«é‡å†™çš„ï¼‰ï¼›
è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œæ ¹æ®ç±»æŒ‡é’ˆ -> æ‰¾åˆ° =*__vptr=  -> å†æ‰¾åˆ°å¯¹åº”çš„ è™šå‡½æ•°è¡¨ -> è°ƒç”¨å¯è°ƒç”¨çš„å‡½æ•°ç‰ˆæœ¬ã€‚
ï¼ˆ *æ€§èƒ½* ï¼šè™šå‡½æ•° æ¯” éè™šå‡½æ•° *è°ƒç”¨æ…¢* ã€ *ä½“ç§¯å¤§* ï¼‰
- è™šå‡½æ•°è¡¨ :: ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾å‡½æ•°æŒ‡é’ˆï¼ˆæ´¾ç”Ÿç±»æœ‰é‡å†™å­˜æ”¾é‡å†™ç‰ˆæœ¬ï¼Œå¦åˆ™å­˜æ”¾åŸºç±»ç‰ˆæœ¬ï¼‰ï¼ŒæŒ‡å‘è¯¥ç±»å¯ä»¥è°ƒç”¨çš„å‡½æ•°ç‰ˆæœ¬ã€‚ *ç¼–è¯‘æ—¶ç”Ÿæˆ* -> æœ‰è™šå‡½æ•°çš„ç±»åŠå…¶æ´¾ç”Ÿç±»å„è‡ªéƒ½æœ‰
- è™šå‡½æ•°æŒ‡é’ˆ :: æŒ‡å‘è™šå‡½æ•°è¡¨ã€‚ *è¿è¡Œæ—¶åˆ›å»ºå¯¹è±¡æ—¶ç¡®å®š* ->  åˆ›å»ºç±»å¯¹è±¡æ—¶ï¼Œåœ¨åŸºç±»æ·»åŠ ï¼Œç„¶åæŒ‡å‘è¯¥ç±»ï¼ˆåŸºç±»æˆ–æ´¾ç”Ÿç±»ï¼‰çš„è™šè¡¨
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
    // VirtualTable* __vptr; ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ  è™šå‡½æ•°æŒ‡é’ˆ
    virtual void function1() {};
    virtual void function2() {};};

// D1ã€D2 æ˜¯æ´¾ç”Ÿç±»ï¼Œä¼šç»§æ‰¿ è™šå‡½æ•°æŒ‡é’ˆ
class D1: public Base {
public:
    void function1() override {};};

class D2: public Base {
public:
    void function2() override {};};

int main() {
  D1 d1 {};           // D1åˆ›å»ºï¼Œ*__vptr æŒ‡å‘ D1è™šè¡¨
  Base* dPtr = &d1;   // BaseæŒ‡é’ˆ æŒ‡å‘ D1çš„åŸºç±»éƒ¨åˆ†ï¼Œåˆ *__vptr æŒ‡å‘ D1è™šè¡¨ï¼Œå› æ­¤å¯ä»¥è®¿é—® D1çš„è™šå‡½æ•°è¡¨
  dPtr->function1();  // ç¨‹åºè¯†åˆ«å‡ºè¿™æ˜¯è™šå‡½æ•°ï¼Œé€šè¿‡ è™šå‡½æ•°è¡¨ è§£æå‡º D1::function1()
  Base b {};          // Baseåˆ›å»ºï¼Œ*__vptr æŒ‡å‘ Baseè™šè¡¨
  Base* bPtr = &b;
  bPtr->function1();  // è°ƒç”¨ Base::function1
}
#+end_src


**** ğŸ“– é¢è¯•é¢˜
***** æ„é€ å‡½æ•°/ææ„å‡½æ•° ä¸­èƒ½å¦è°ƒç”¨ è™šå‡½æ•°ï¼Ÿ
å¯ä»¥ï¼Œä½†ä¸å»ºè®®ï¼Œå› ä¸ºå¯èƒ½æ²¡æ³•è§¦å‘å¤šæ€ï¼Œæ— æ³•è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„
- æ„é€ æ´¾ç”Ÿç±»ï¼Œå…ˆæ„é€ åŸºç±»ï¼ŒåŸºç±»æ„é€ å‡½æ•°ä¸­è°ƒç”¨è™šå‡½æ•°ï¼Œå¸Œæœ›è§¦å‘æ´¾ç”Ÿç±»ç‰ˆæœ¬ï¼Œä½†æ´¾ç”Ÿç±»è¿˜æ²¡æ„é€ ï¼Œåªèƒ½è§¦å‘åŸºç±»ç‰ˆæœ¬
- ææ„æ´¾ç”Ÿç±»ï¼Œå…ˆææ„æ´¾ç”Ÿç±»ï¼Œåææ„åŸºç±»ï¼ŒåŸºç±»ä¸­è°ƒç”¨è™šå‡½æ•°ï¼Œå¸Œæœ›è§¦å‘æ´¾ç”Ÿç±»ç‰ˆæœ¬ï¼Œä½†æ´¾ç”Ÿç±»å·²ç»ææ„äº†ï¼Œåªèƒ½è§¦å‘åŸºç±»ç‰ˆæœ¬


**** override
:PROPERTIES:
:ID:       31b2e0ac-529e-482b-b728-2996e0591fe5
:END:
å£°æ˜é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥
1. *é‡å†™è§„åˆ™* ï¼šæ´¾ç”Ÿç±»çš„ *å‡½æ•°ç­¾åã€è¿”å›ç±»å‹* ä¸ åŸºç±»ç›¸åŒ [fn:15]
2. *åå˜è¿”å›ç±»å‹* ï¼šåŸºç±»è™šå‡½æ•° è¿”å›ç±»çš„æŒ‡é’ˆ/å¼•ç”¨ï¼Œé‡å†™å‡½æ•°è¿”å›æŒ‡å‘æ´¾ç”Ÿç±»çš„æŒ‡é’ˆ/å¼•ç”¨ -> *è§†ä¸ºé‡å†™ï¼ˆå³ä½¿é‡å†™å‡½æ•°è¿”å›ç±»å‹ä¸åŒï¼‰*[fn:16]


**** final
:PROPERTIES:
:ID:       ce6707f0-21ee-474d-b89d-f411214e7f1f
:END:
1. ç¦æ­¢é‡å†™è™šå‡½æ•°ï¼šåœ¨å‡½æ•°åä½¿ç”¨ [fn:17]
2. ç¦æ­¢ç»§æ‰¿      ï¼šåœ¨ç±»ååä½¿ç”¨ [fn:18]


**** çº¯è™šå‡½æ•°
:PROPERTIES:
:ID:       0cad2baa-3615-47c4-b059-b227d58b109c
:END:
- çº¯è™šå‡½æ•° :: =virtual= å£°æ˜çš„å‡½æ•°ï¼Œæœ«å°¾æ·»åŠ  ==0= æ ‡è®°ï¼Œç”¨äºå®šä¹‰ *æ¥å£è§„èŒƒ*  ï¼Œå¼ºåˆ¶æ´¾ç”Ÿç±»å®ç°æ‰€æœ‰çº¯è™šå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è®©è¿™ä¸ªç±»å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ï¼‰


***** æŠ½è±¡ç±»
:PROPERTIES:
:ID:       b5b6f1f5-69a7-41dc-b27d-8c55cae67146
:END:
- æŠ½è±¡ç±» :: æœªå®ç°åŸºç±»çš„æ‰€æœ‰çº¯è™šå‡½æ•°çš„æ´¾ç”Ÿç±»
  1. æŠ½è±¡ç±»æ— æ³•å®ä¾‹åŒ–ï¼ˆè¡¨ç¤ºæ˜¯æ²¡å®ç°è¦æ±‚çš„æ¥å£è§„èŒƒï¼Œæ²¡æ³•ç”¨ï¼‰
  2. æŠ½è±¡ç±»æœ‰ [[id:b23cd926-82ec-489e-ad8f-96b86e5559c2][è™šå‡½æ•°]]è¡¨


***** æ¥å£ç±»
:PROPERTIES:
:ID:       c93a8d2f-664b-4f8a-93b3-162561e42f16
:END:
- æ¥å£ç±» :: ä»…åŒ…å«çº¯è™šå‡½æ•°çš„ç±»ï¼Œç”¨äºå®šä¹‰ä¸€å¥—æ¥å£è§„èŒƒï¼Œ *è§£è€¦* æ¥å£å’Œå®ç°ï¼ˆåˆ†åˆ«å¯¹åº” åšä»€ä¹ˆã€æ€ä¹ˆåšï¼‰
  1. æ²¡æœ‰æˆå‘˜å˜é‡ï¼Œæ‰€æœ‰å‡½æ•°éƒ½æ˜¯çº¯è™šå‡½æ•°ï¼Œæ¥å£ç±»çš„æ´¾ç”Ÿç±»éœ€è¦å®ç°æ‰€æœ‰çº¯è™šå‡½æ•°
  2. ä½¿ç”¨åœºæ™¯ï¼šå‡½æ•°å‚æ•° [fn:19]



* Footnotes

[fn:1]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class A {
public:
    A(int a) { std::cout << "A: " << a << '\n'; }
};

class B: public A {
public:
    B(int a, double b) : A{ a } { std::cout << "B: " << b << '\n'; }
};

class C: public B {
public:
    C(int a, double b, char c) : B{ a, b } { std::cout << "C: " << c << '\n'; }
};

int main() {
    C c{ 5, 4.3, 'R' }; // NOTE æ„é€ é¡ºåºï¼šA -> B -> C
}                       // NOTE é”€æ¯é¡ºåºï¼šC -> B -> A
#+end_src

#+RESULTS:
: A: 5
: B: 4.3
: C: R

[fn:2]
#+name: æ›´æ”¹ç»§æ‰¿æˆå‘˜çš„è®¿é—®æƒé™
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
    int m_value{};
    int getValue() const { return m_value; }
    int getValue(int) const { return m_value; }
};

class Derived : public Base {
private:
  using Base::getValue;             // NOTE æ”¹å˜ getValueå‡½æ•°çš„è®¿é—®æƒé™ä¸º private

public:
  Derived(int value) : Base { value } { }
};

int main() {
  Derived derived{ 7 };
  std::cout << derived.getValue();  // FIXME getValue() åœ¨ Derived private
  std::cout << derived.getValue(5); // FIXME getValue(int) åœ¨ Derived æ˜¯ private
}
#+end_src

#+name: å°†çˆ¶ç±»å‡½æ•°åŠ å…¥æ´¾ç”Ÿç±»è¿›è¡Œå‡½æ•°é‡è½½
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
    void print(int)    { std::cout << "Base::print(int)\n"; }
    void print(double) { std::cout << "Base::print(double)\n"; }
};

class Derived: public Base {
public:
    using Base::print; // NOTE å°†åŸºç±»çš„printåŠ å…¥æ´¾ç”Ÿç±»ä½œç”¨åŸŸï¼Œä½¿å…¶å¯ä»¥å‚ä¸ å‡½æ•°é‡è½½è§£æ
    void print(double) { std::cout << "Derived::print(double)"; }
};

int main() {
    Derived d{};
    // å‚æ•°æ˜¯intï¼Œæˆ‘ä»¬å¸Œæœ›è°ƒç”¨ Base::print(int)ï¼Œè‹¥æ²¡æœ‰ä½¿ç”¨usingï¼Œåˆ™ä¼šè°ƒç”¨ Derived::print(double)
    d.print(5); // è°ƒç”¨Base::print(int)
}
#+end_src

#+RESULTS:
: Base::print(int)

[fn:3]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
protected:
    int m_value {};

public:
    Base(int value) : m_value { value } { }

    void identify() const { std::cout << "I am a Base\n"; }
};

class Derived: public Base {
public:
    Derived(int value) : Base { value } { }

    // NOTE åœ¨æ´¾ç”Ÿç±»æ‰©å±•åŠŸèƒ½ï¼šè®¿é—®åŸºç±»æˆå‘˜
    int getValue() const { return m_value; }
};

int main() {
    Derived derived { 5 };
    std::cout << "derived has value " << derived.getValue() << '\n';
}
#+end_src

#+RESULTS:
: derived has value 5

[fn:4]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
    Base() { }

    void identify() const { std::cout << "Base::identify()\n"; }
};

class Derived: public Base {
public:
    Derived() { }

    void identify() const {
        std::cout << "Derived::identify()\n";
        Base::identify(); // NOTE ä½¿ç”¨ åŸºç±»ä½œç”¨åŸŸé™å®šç¬¦ï¼Œè°ƒç”¨ Base::identify()
        // identify(); è¿™æ ·è°ƒç”¨ FIXME ä¼šæ— çº¿é€’å½’
    }
};

int main() {
    Derived derived {};
    derived.identify();
}
#+end_src

#+RESULTS:
: Derived::identify()
: Base::identify()

[fn:5]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
  Base() { }

  friend std::ostream& operator<< (std::ostream& out, const Base&) {
    out << "In Base\n";
    return out;
  }
};

class Derived: public Base {
public:
  Derived() { }

  friend std::ostream& operator<< (std::ostream& out, const Derived& d) {
    out << "In Derived\n";
    // NOTE static_cast å°†æ´¾ç”Ÿç±» è½¬ä¸º åŸºç±»ï¼Œè°ƒç”¨ åŸºç±»å‹å…ƒå‡½æ•° operator<<
    out << static_cast<const Base&>(d);
    return out;
  }
};

int main() {
    Derived derived {};

    std::cout << derived << '\n';
}
#+end_src

#+RESULTS:
: In Derived
: In Base
:

[fn:6]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
    Base() { }

    void identify() const { std::cout << "Base::identify()\n"; }
    void name() { cout << "Base\n"; }
};

class Derived: public Base {
public:
    Derived() { }
    void name() { cout << "Derived\n"; }
};

int main() {
    Derived derived {};
    derived.identify();      // NOTE è°ƒç”¨åŸºç±»ç‰ˆæœ¬ï¼ˆæ´¾ç”Ÿç±»ä¸­æ‰¾ä¸åˆ°ï¼Œå»åŸºç±»ä¸­æŸ¥æ‰¾ï¼‰
    derived.name();          // NOTE è°ƒç”¨æ´¾ç”Ÿç±»ç‰ˆæœ¬ï¼ˆé‡æ–°å®šä¹‰åŸºç±»å‡½æ•°ï¼‰
}
#+end_src

#+RESULTS:
: Base::identify()
: Derived

[fn:7]
#+begin_src cpp :results output :namespaces std :includes <iostream>
/* å¸¸è§æƒ…å†µ */
Derived derived{ 5 };
Base base{ derived }; // èµ‹å€¼å¯¼è‡´å¯¹è±¡åˆ‡ç‰‡

/* ä¸€ä¸ªä¸æ˜æ˜¾çš„ä¾‹å­ */
Derived d1{ 5 };
Derived d2{ 6 };
Base& b{ d2 }; // åŸºç±»å¼•ç”¨b æŒ‡å‘ æ´¾ç”Ÿç±»d2çš„åŸºç±»éƒ¨åˆ†
b = d1;        // å¯¹è±¡åˆ‡ç‰‡ï¼šd1 çš„ Baseéƒ¨åˆ† å¤åˆ¶åˆ° d2
               // ç°åœ¨ d2 æœ‰ d1åŸºç±»éƒ¨åˆ†ã€d2æ´¾ç”Ÿç±»éƒ¨åˆ†
#+end_src

[fn:8]
#+begin_src cpp :results output :namespaces std :includes <iostream>
// void printName(const Base base)   FIXME å€¼ä¼ é€’ ç±»å¯¹è±¡ -> å‘ç”Ÿå¯¹è±¡åˆ‡ç‰‡
void printName(const Base& base) { // NOTE å¼•ç”¨ä¼ é€’ ç±»å¯¹è±¡
    std::cout << "I am a " << base.getName() << '\n';
}

int main() {
    Derived d{ 5 };
    printName(d);
}
#+end_src

[fn:9]
#+name:  å€¼ä¼ é€’
#+begin_src cpp :results output :namespaces std :includes <iostream> <vector>
int main() {
  std::vector<Base> v{};     // å€¼ä¼ é€’å½¢å¼ï¼Œæ·»åŠ å¯¹è±¡åˆ°å®¹å™¨ -> å‘ç”Ÿ å¯¹è±¡åˆ‡ç‰‡
  v.push_back(Base{ 5 });    // æ·»åŠ åŸºç±»å¯¹è±¡
  v.push_back(Derived{ 6 }); // æ·»åŠ æ´¾ç”Ÿç±»å¯¹è±¡

  for (const auto& element : v)
    std::cout << "I am a " << element.getName() << " with value " << element.getValue() << '\n';
  // è¾“å‡ºï¼š
  // I am a Base with value 5
  // I am a Base with value 6
}
#+end_src

#+name: æŒ‡é’ˆ
#+begin_src cpp :results output :namespaces std :includes <iostream> <vector>
int main()
{
  std::vector<Base*> v{}; // okï¼šæŒ‡é’ˆçš„æ–¹å¼ æ·»åŠ å¯¹è±¡åˆ°å®¹å™¨

  Base b{ 5 };
  Derived d{ 6 };

  v.push_back(&b);
  v.push_back(&d);

  for (const auto* element : v)
    std::cout << "I am a " << element->getName() << " with value " << element->getValue() << '\n';
}
#+end_src

#+name: å¼•ç”¨ï¼ˆstd::reference_wrapperï¼‰
#+begin_src cpp :results output :namespaces std :includes <iostream> <vector> <string_view> <functional>
class Base {
protected:
    int m_value{};

public:
    Base(int value) : m_value{ value } { }
    virtual ~Base() = default;

    virtual std::string_view getName() const { return "Base"; }
    int getValue() const { return m_value; }
};

class Derived : public Base {
public:
    Derived(int value) : Base{ value } { }

    std::string_view getName() const override { return "Derived"; }
};

int main() {
  std::vector<std::reference_wrapper<Base>> v{}; // std::reference_wrapper æ¨¡æ‹Ÿå¯é‡æ–°èµ‹å€¼å¼•ç”¨çš„ç±»

  Base b{ 5 };
  Derived d{ 6 };

  v.push_back(b);
  v.push_back(d);

  for (const auto& element : v)
    std::cout << "I am a " << element.get().getName() << " with value " << element.get().getValue() << '\n';
}
#+end_src

#+RESULTS: å¼•ç”¨ï¼ˆstd::reference_wrapperï¼‰
: I am a Base with value 5
: I am a Derived with value 6


[fn:10]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class PoweredDevice {
public:
    PoweredDevice(int power) {
      std::cout << "PoweredDevice: " << power << '\n';
    }
};

class Scanner: public PoweredDevice {
public:
    Scanner(int scanner, int power)
        : PoweredDevice{ power } {
      std::cout << "Scanner: " << scanner << '\n';
    }
};

class Printer: public PoweredDevice {
public:
    Printer(int printer, int power)
        : PoweredDevice{ power } {
      std::cout << "Printer: " << printer << '\n';
    }
};

class Copier: public Scanner, public Printer {
public:
    Copier(int scanner, int printer, int power)
        : Scanner{ scanner, power }, Printer{ printer, power } { }
};

int main() {
    Copier copier{ 1, 2, 3 }; // Printerã€Scanneréƒ½è°ƒç”¨äº† PoweredDeviceæ„é€ å‡½æ•°ï¼Œå› æ­¤ä»–ä¿©éƒ½æœ‰ PoweredDeviceçš„æˆå‘˜å˜é‡ï¼›Copierä¸­å°±æœ‰ä¸¤ä»½ PoweredDeviceçš„æˆå‘˜å˜é‡ -> é—®é¢˜ï¼šCopierç±»å¯¹è±¡ä½“ç§¯å¤§ï¼Œè®¿é—® PoweredDevice ä¸­çš„æˆå‘˜å˜é‡ä¼šå‡ºç°æ¨¡æ£±ä¸¤å¯çš„é—®é¢˜
}
#+end_src

#+RESULTS:
: PoweredDevice: 3
: Scanner: 1
: PoweredDevice: 3
: Printer: 2

[fn:11]
#+begin_src cpp :results output :namespaces std :includes <iostream>
// PoweredDevice è™šåŸºç±»
class PoweredDevice {
public:
    PoweredDevice(int power) {
      std::cout << "PoweredDevice: " << power << '\n';
    }
};

class Scanner: virtual public PoweredDevice {
public:
    Scanner(int scanner, int power)
        : PoweredDevice{ power } {
      std::cout << "Scanner: " << scanner << '\n';
    }
};

class Printer: virtual public PoweredDevice {
public:
    Printer(int printer, int power)
        : PoweredDevice{ power } {
      std::cout << "Printer: " << printer << '\n';
    }
};

class Copier: public Scanner, public Printer {
public:
    Copier(int scanner, int printer, int power)
        // NOTE æœ€æ´¾ç”Ÿç±» è´Ÿè´£æ„é€  æœ€åŸºç±» PoweredDevice
        : PoweredDevice{ power }, Scanner{ scanner, power }, Printer{ printer, power } { }
        // NOTE åˆ›å»ºé¡ºåºï¼šPoweredDevice -> Scanner -> Printer -> Copierã€‚Scannerã€Printer ä»ç„¶ä¼šè°ƒç”¨ PoweredDeviceæ„é€ å‡½æ•°ï¼Œä½†æ˜¯ä¼šè¢«å¿½ç•¥
};

int main() {
    Copier copier{ 1, 2, 3 };
}
#+end_src

#+RESULTS:
: PoweredDevice: 3
: Scanner: 1
: Printer: 2


[fn:12]
#+name: åŸºç±»æŒ‡é’ˆ/å¼•ç”¨è°ƒç”¨å‡½æ•°çš„ä¸åŒç‰ˆæœ¬
#+begin_src cpp :results output :namespaces std :includes <iostream> <string_view>
class A {
public:
  virtual std::string_view getName() const { return "A"; }};

class B: public A {
public:
  std::string_view getName() const { return "B"; }};

class C: public B {
public:
  std::string_view getName() const { return "C"; }};

int main() {
    C c {};
    // é€šè¿‡åŸºç±» æŒ‡é’ˆæˆ–å¼•ç”¨è°ƒç”¨ è™šå‡½æ•°æ—¶ï¼Œè°ƒç”¨çš„æ˜¯å¯¹è±¡çš„å®é™…ç±»å‹çš„æœ€æ´¾ç”Ÿç‰ˆæœ¬
    A& rBase{ c };
    std::cout << "rBase is a " << rBase.getName() << '\n';
    A* pBase{ &c };
    std::cout << "pBase is a " << pBase->getName() << '\n';
    // é€šè¿‡åŸºç±» ç›´æ¥è°ƒç”¨ è™šå‡½æ•°ï¼Œè°ƒç”¨çš„æ˜¯å¯¹è±¡çš„ç›¸åŒç±»å‹çš„ç‰ˆæœ¬
    A a { c };
    std::cout << " Base is a " << a.getName();
}
#+end_src

[fn:13]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Base {
public:
    virtual ~Base() { // NOTE åŸºç±»ææ„å‡½æ•° åº”è¯¥è®¾ç½®ä¸º virtualï¼Œå¦åˆ™ delete Baseç±»å‹çš„æŒ‡é’ˆæ—¶ï¼Œæ´¾ç”Ÿç±»ææ„å‡½æ•°ä¸ä¼šè°ƒç”¨
        std::cout << "Calling ~Base()\n";
    }
};

class Derived: public Base {
private:
    int* m_array {};
public:
    Derived(int length)
      : m_array{ new int[length] } { }

    ~Derived() { // åŸºç±»æ˜¯ virtualï¼Œæ­¤å¤„éšå¼çš„ä¸º virtual
        std::cout << "Calling ~Derived()\n";
        delete[] m_array;
    }
};

int main() {
    Derived* derived { new Derived(5) };
    Base* base { derived };

    delete base;
}
#+end_src

#+RESULTS:
: Calling ~Derived()
: Calling ~Base()

[fn:14]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Animal {}
class Cat : public Animal {}
class Dog : public Animal {}
// NOTE å‚æ•°ä½¿ç”¨ æŒ‡å‘åŸºç±»çš„å¼•ç”¨/æŒ‡é’ˆï¼Œå¯ä»¥ä¼ å…¥æ´¾ç”Ÿç±»
void report(const Animal& rAnimal) { }
#+end_src

[fn:15]
#+begin_src cpp :results output :namespaces std :includes <iostream> <string_view>
class A {
public:
  virtual int getValue() const { return 5; }
  virtual std::string_view getName1(int x) { return "A"; }
  virtual std::string_view getName2(int x) { return "A"; }
  virtual std::string_view getName3(int x) { return "A"; }};

class B : public A {
public:
  // virtual double getValue() const { return 6.78; }};               // NOTE æ²¡æœ‰é‡å†™ï¼šè¿”å›ç±»å‹ä¸åŒ
  // std::string_view getName1(short int x) override { return "B"; }  // FIXME é‡å†™å¤±è´¥ï¼šå‡½å‚ä¸åŒ
  // std::string_view getName2(int x) const override { return "B"; }  // FIXME é‡å†™å¤±è´¥ï¼šconst
  std::string_view getName3(int x) override { return "B"; }           // ok
};

int main() {
  B b{};
  A* pb {&b};
  A& rb {b};
  cout << "pb is " << pb->getName3(2) << endl;
  cout << "rb is " << rb.getName3(2) << endl;
}
#+end_src

#+RESULTS:
: pb is B
: rb is B

[fn:16]
#+begin_src cpp :results output :namespaces std :includes <iostream> <string_view>
class Base {
public:
	// è¿”å›ç±»çš„æŒ‡é’ˆ/å¼•ç”¨ï¼šBase*
	virtual Base* getThis() { std::cout << "called Base::getThis()\n"; return this; }
	void printType() { std::cout << "returned a Base\n"; }
};

class Derived : public Base {
public:
  // è¿”å›æ´¾ç”Ÿç±»çš„æŒ‡é’ˆ/å¼•ç”¨ï¼šDerived*
	Derived* getThis() override { std::cout << "called Derived::getThis()\n";  return this; }
	void printType() { std::cout << "returned a Derived\n"; }
};

int main() {
	Derived d{};
	Base* b{ &d };
	d.getThis()->printType();
	b->getThis()->printType();
}
#+end_src

#+RESULTS:
: called Derived::getThis()
: returned a Derived
: called Derived::getThis()
: returned a Base

[fn:17]
#+begin_src cpp :results output :namespaces std :includes <iostream> <string_view>
class A {
public:
  virtual std::string_view getName() const { return "A"; }
};

class B : public A {
public:
  // NOTE ä½¿ç”¨ final
  std::string_view getName() const override final { return "B"; } // okay, é‡å†™ A::getName()
};

class C : public B {
public:
  std::string_view getName() const override { return "C"; }       // FIXME ä¸èƒ½é‡å†™ getName()ï¼Œå› ä¸ºæ˜¯ final
};
#+end_src

[fn:18]
#+begin_src cpp :results output :namespaces std :includes <iostream> <string_view>
class A {
public:
  virtual std::string_view getName() const { return "A"; }};

// NOTE ä½¿ç”¨ finalï¼Œé˜²æ­¢ B è¢«ç»§æ‰¿
class B final : public A {
public:
  std::string_view getName() const override { return "B"; }};

// FIXMEï¼šä¸èƒ½ç»§æ‰¿ final ç±»
class C : public B {
public:
  std::string_view getName() const override { return "C"; }};
#+end_src

[fn:19]
#+begin_src cpp :results output :namespaces std :includes <iostream>
// æ¥å£ï¼ˆç¨³å®šï¼‰
class DataStorage {
public:
    virtual void save(const std::string& data) = 0;         // çº¯è™šå‡½æ•°
    virtual std::string load() = 0;
    virtual ~DataStorage() = default;                       // NOTE æ³¨æ„ç‚¹1ï¼šå¿…é¡»æ˜¯è™šææ„ï¼Œå¦åˆ™æ²¡æ³•è°ƒç”¨æ´¾ç”Ÿç±»ææ„
};

// å®ç°1ï¼šMySQLå­˜å‚¨
class MySQLStorage : public DataStorage { /* å…·ä½“å®ç° */ }; // NOTE æ³¨æ„ç‚¹3ï¼šæ´¾ç”Ÿç±»å¿…é¡»å®ç°æ‰€æœ‰çº¯è™šå‡½æ•°

// å®ç°2ï¼šRediså­˜å‚¨
class RedisStorage : public DataStorage { /* å…·ä½“å®ç° */ };

// NOTE è°ƒç”¨è€…åªéœ€ä¾èµ–æ¥å£ï¼Œä¸å…·ä½“å®ç°è§£è€¦ï¼Œåç»­å¯ä»¥ä¼ å…¥å…·ä½“å®ç°
void processData(DataStorage& storage) {                    // NOTE æ³¨æ„ç‚¹2ï¼šä½¿ç”¨æŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œå¦åˆ™å¯¹è±¡åˆ‡ç‰‡
    storage.save("hello"); // æ— éœ€çŸ¥é“æ˜¯MySQLè¿˜æ˜¯Redis
}
#+end_src
