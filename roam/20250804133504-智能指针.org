:PROPERTIES:
:ID:       7cb0d4aa-e74a-4563-acf6-053e129105e9
:END:
#+title: æ™ºèƒ½æŒ‡é’ˆ
#+filetags: cpp

* æ™ºèƒ½æŒ‡é’ˆ
- æ™ºèƒ½æŒ‡é’ˆ :: RAII æ€æƒ³çš„ä½“ç°ï¼Œç”¨ ç±»çš„ç”Ÿå‘½å‘¨æœŸ è‡ªåŠ¨ç®¡ç†èµ„æºã€‚å¦‚ä¸‹ï¼š
  1. [[id:1bb26420-ad68-42fa-aa2e-f2f72977a5c9][std::unique_ptr]]
  2. [[id:1b0f6b90-ad0b-49a3-9868-fa9345c70b60][std::shared_ptr]]
  3. [[id:fdebcab9-1f2c-41e4-89fc-075025234c9b][std::weak_ptr]]


** std::unique_ptr
:PROPERTIES:
:ID:       1bb26420-ad68-42fa-aa2e-f2f72977a5c9
:END:
- std::unique_ptr :: ï¼ˆcpp11ï¼‰ *ç‹¬å èµ„æº* çš„æ™ºèƒ½æŒ‡é’ˆï¼Œä¸€æ¬¡åªæœ‰ä¸€ä¸ªè¿™æ ·çš„æŒ‡é’ˆç®¡ç†èµ„æºï¼Œä¸å¯æ‹·è´ï¼Œå¯ç§»åŠ¨
  1. *åº•å±‚* ï¼šæŒ‡é’ˆæŒ‡å‘ èµ„æº
  2. ï¼ˆcpp14ï¼‰æ¨èä½¿ç”¨ =std::make_unique= ï¼Œæ›´ç®€æ´ï¼Œä¸”è§£å†³äº†ä¸€ä¸ªå¼‚å¸¸å®‰å…¨é—®é¢˜ [fn:1]
  3. *ä¼ å‚ç»™å‡½æ•°* ä½¿ç”¨ è£¸æŒ‡é’ˆ =std::unique_ptr.get()= è€Œä¸æ˜¯ =std::unique_ptr= ï¼ˆåè€…ä¼šå¯¼è‡´ *èµ„æºæ‰€æœ‰æƒè½¬ç§»åˆ°å‡½æ•°* é‡Œï¼‰[fn:2]
  4. *å‡½æ•°è¿”å›* ä½¿ç”¨ å€¼ä¼ é€’ è¿”å›å°±è¡Œï¼ˆç§»åŠ¨è¯­ä¹‰å¯ç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨ï¼‰[fn:3]


** std::shared_ptr
:PROPERTIES:
:ID:       1b0f6b90-ad0b-49a3-9868-fa9345c70b60
:END:
- std::shared_ptr :: ï¼ˆcpp11ï¼‰ *å…±äº«èµ„æº* çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå¤šä¸ªæŒ‡é’ˆå…±åŒç®¡ç†èµ„æº
  1. *åº•å±‚* ä¸»è¦æœ‰ï¼šæŒ‡å‘èµ„æºçš„æŒ‡é’ˆ + æŒ‡å‘ *æ§åˆ¶å—* çš„æŒ‡é’ˆã€‚æ§åˆ¶å—ä¸­æœ‰ï¼š[fn:4]
     - å¼ºå¼•ç”¨è®¡æ•°ï¼ˆ =use_count= ï¼‰ ï¼šè¡¨ç¤ºç®¡ç†èµ„æºçš„å…±äº«æŒ‡é’ˆæ•°é‡ï¼Œç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸï¼›
       æ¯å¢åŠ ä¸€ä¸ªå…±äº«æŒ‡é’ˆç®¡ç†èµ„æºï¼š =use_count+1= ï¼Œæ¯å‡å°‘ï¼š =use_count-1= ï¼Œ =use_count=0= æ—¶ï¼Œ =weak_count-1= é”€æ¯èµ„æº
     - å¼±å¼•ç”¨è®¡æ•°ï¼ˆ =weak_count= ï¼‰ï¼šè¡¨ç¤ºè§‚å¯Ÿèµ„æºçš„ std::weak_ptr æ•°é‡ï¼Œç®¡ç†æ§åˆ¶å—ç”Ÿå‘½å‘¨æœŸï¼›
       æ¯å¢åŠ ä¸€ä¸ªå¼±æŒ‡é’ˆè§‚å¯Ÿèµ„æºï¼š =weak_count+1= ï¼Œæ¯å‡å°‘ï¼š =weak_count-1= ï¼Œ =weak_count=0= æ—¶ï¼Œé”€æ¯æ§åˆ¶å—
  2. ğŸ”¥ é€šè¿‡æ‹·è´ =std::shared_ptr= çš„æ‹·è´æ„é€  *å…±åŒç®¡ç†èµ„æº* [fn:5]
  3. =std::make_shared()= *åˆå§‹åŒ–* æ™ºèƒ½æŒ‡é’ˆï¼Œç®€å•å®‰å…¨
  4. åˆ›å»ºè¿”å›æ™ºèƒ½æŒ‡é’ˆçš„å‡½æ•°ï¼Œ *è¿”å›std::unique_ptr*
     - [[id:02ce83ed-31b4-4906-89e4-271bbf432834][std::unique_ptr]]  --å¯ä»¥è½¬æ¢-->  std::shared_ptr
     - std::shared_ptr  --ä¸èƒ½è½¬æ¢-->  std::unique_ptr
  5. *å¾ªç¯å¼•ç”¨* é—®é¢˜ï¼Œä½¿ç”¨[[id:fdebcab9-1f2c-41e4-89fc-075025234c9b][std::weak_ptr]]


** std::weak_ptr
:PROPERTIES:
:ID:       fdebcab9-1f2c-41e4-89fc-075025234c9b
:END:
- å¾ªç¯å¼•ç”¨ :: ä¸¤ä¸ªå¯¹è±¡å†…éƒ¨çš„ std::shared_ptr äº’ç›¸æŒ‡å‘å¯¹æ–¹ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ— æ³•å½’ 0ï¼Œå†…å­˜æ³„æ¼ ã€‚è§£å†³æ–¹å¼ï¼šå°†å…¶ä¸­ä¸€ä¸ªç±»å†…éƒ¨æŒ‡é’ˆæ”¹ä¸º std::weak_ptr [fn:6]
- std::weak_ptr :: ï¼ˆcpp11ï¼‰ç”¨äºè§£å†³ std::shared_ptr äº§ç”Ÿçš„ *å¾ªç¯å¼•ç”¨* é—®é¢˜ï¼Œå› ä¸ºæ˜¯èµ„æºçš„ *è§‚å¯Ÿè€…* ï¼Œä¸æ˜¯æ‰€æœ‰è€…ï¼Œ *ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°* ï¼Œå†…éƒ¨ç»“æ„è§ï¼š[[id:f8158484-8008-4cb1-86a6-f9a86e5501ae][å›¾:shared_ptrå’Œweak_ptrå†…éƒ¨ç»“æ„]]
  1. ä½¿ç”¨ =lock()= è½¬ä¸º std::shared_ptr åè®¿é—®å†…éƒ¨èµ„æºï¼ˆstd::weak_ptr æ²¡æœ‰ =operator->= ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼‰[fn:7]
  2. ä½¿ç”¨ =expired()= åˆ¤æ–­æ˜¯å¦æŒ‡å‘æ— æ•ˆå¯¹è±¡ [fn:8]


***  é™„ä»¶
**** å›¾:shared_ptrå’Œweak_ptrå†…éƒ¨ç»“æ„ :ATTACH:
:PROPERTIES:
:ID:       f8158484-8008-4cb1-86a6-f9a86e5501ae
:END:
[[attachment:_20250810_170251screenshot.png]]


* Footnotes

[fn:1]
#+begin_src cpp
// ç¼–è¯‘å™¨å¯èƒ½çš„å¤„ç†é¡ºåºï¼šT -> function_that_can_throw_exception -> std::unique_ptr
// å¯èƒ½çš„å¼‚å¸¸å®‰å…¨é—®é¢˜  ï¼šT å·²ç»è¢«åˆ›å»ºï¼Œå‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œä½† std::unique_ptr è¿˜æ²¡åˆ›å»ºå¥½ï¼Œé€ æˆå†…å­˜æ³„æ¼
some_function(std::unique_ptr<T>(new T), function_that_can_throw_exception());

// ä¸ä¼šå†…å­˜æ³„æ¼ï¼šT å’Œ std::unique_ptr éƒ½åœ¨ make_unique å†…éƒ¨åˆ›å»º
some_function(std::make_unique<T>(), function_that_can_throw_exception());
#+end_src

[fn:2]
#+name: ä¼ é€’ unique_ptr åˆ°å‡½æ•°
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory> <utility>
class Resource {
public:
	Resource() { std::cout << "Resource acquired\n"; }
	~Resource() { std::cout << "Resource destroyed\n"; }
};

std::ostream& operator<<(std::ostream& out, const Resource&) {
	out << "I am a resource";
	return out;
}

// NOTE è¿™ä¸ªå‡½æ•°è·å– èµ„æºçš„ç®¡ç†æƒï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„
void takeOwnership(std::unique_ptr<Resource> res) {
     if (res)
          std::cout << *res << '\n';
} // NOTE èµ„æºåœ¨è¿™é‡Œé‡Šæ”¾

int main() {
    auto ptr{ std::make_unique<Resource>() };

    // takeOwnership(ptr);         // FIXME std::unique_ptr æ²¡æœ‰æ‹·è´è¯­ä¹‰
    takeOwnership(std::move(ptr)); // ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰

    std::cout << "Ending program\n";
}
#+end_src

#+RESULTS:
: Resource acquired
: I am a resource
: Resource destroyed
: Ending program

#+name: ä¼ é€’ è£¸æŒ‡é’ˆ åˆ°å‡½æ•°
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
class Resource {
public:
	Resource() { std::cout << "Resource acquired\n"; }
	~Resource() { std::cout << "Resource destroyed\n"; }
};

std::ostream& operator<<(std::ostream& out, const Resource&) {
	out << "I am a resource";
	return out;
}

// NOTE æ¥å—è£¸æŒ‡é’ˆï¼šè¡¨ç¤ºå‡½æ•°åªä½¿ç”¨èµ„æºï¼Œè€Œä¸ç®¡ç†èµ„æº
void useResource(const Resource* res) {
	if (res)
		std::cout << *res << '\n';
	else
		std::cout << "No resource\n";
}

int main() {
  auto ptr{ std::make_unique<Resource>() };

  useResource(ptr.get()); // è·å–èµ„æºæœ¬èº«

  std::cout << "Ending program\n";
} // NOTE èµ„æºåœ¨æ­¤å¤„é‡Šæ”¾ï¼Œokï¼šä¹Ÿå°±æ˜¯è¯´ è°ƒç”¨å®Œå‡½æ•°ï¼Œå›åˆ° mainï¼Œèµ„æºä¾æ—§è¢« std::unique_ptr ç®¡ç†ç€
#+end_src

#+RESULTS:
: Resource acquired
: I am a resource
: Ending program
: Resource destroyed

[fn:3]
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
std::unique_ptr<Resource> createResource() { // å€¼ä¼ é€’ è¿”å›ï¼Œç§»åŠ¨è¯­ä¹‰å¯ç”¨æ—¶ï¼Œä¼šç§»åŠ¨ï¼Œæ­¤å¤„ç¼–è¯‘å™¨ è‡ªåŠ¨ä½¿ç”¨ ç§»åŠ¨è¯­ä¹‰
     return std::make_unique<Resource>();
}

int main() {
    auto ptr{ createResource() };
}
#+end_src

[fn:4]
#+begin_comment æ§åˆ¶å—ç¤ºä¾‹
*åœºæ™¯1*
sharedæŒ‡é’ˆAæŒ‡å‘èµ„æºRï¼šæ§åˆ¶å—use_count=1ã€weak_count=1
sharedæŒ‡é’ˆBæŒ‡å‘R    ï¼šuse_count=2ã€weak_count=1
é”€æ¯B               ï¼šuse_count=1ã€weak_count=1
é”€æ¯A               ï¼šuse_count=0ã€weak_count=0

*åœºæ™¯2*
sharedæŒ‡é’ˆAæŒ‡å‘èµ„æºRï¼šæ§åˆ¶å—use_count=1ã€weak_count=1
sharedæŒ‡é’ˆBæŒ‡å‘R    ï¼šuse_count=2ã€weak_count=1
weakæŒ‡é’ˆWæŒ‡å‘R      ï¼šuse_count=2ã€weak_count=2
é”€æ¯B               ï¼šuse_count=1ã€weak_count=2
é”€æ¯A               ï¼šuse_count=0ã€weak_count=1
#+end_comment

[fn:5]
#+name: é”™è¯¯åšæ³• ä»èµ„æºåˆå§‹åŒ–shareæŒ‡é’ˆ
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
class Resource {
public:
  Resource() { std::cout << "Resource acquired\n"; }
  ~Resource() { std::cout << "Resource destroyed\n"; }
};

int main() {
 Resource* res { new Resource };
 std::shared_ptr<Resource> ptr1 { res };   // ç›´æ¥åˆå§‹åŒ– ptr1ï¼ˆä»èµ„æºåˆå§‹åŒ–ï¼‰
 {
   std::shared_ptr<Resource> ptr2 { res }; // FIXME ç›´æ¥åˆå§‹åŒ– ptr2ï¼ˆä»èµ„æºåˆå§‹åŒ–ï¼‰
   std::cout << "Killing one shared pointer\n";
 } // ptr2 è¶…å‡ºä½œç”¨åŸŸ
 std::cout << "Killing another shared pointer\n";
} // ptr1 è¶…å‡ºä½œç”¨åŸŸ
#+end_src

#+name: æ­£ç¡®åšæ³•
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
class Resource
{
public:
  Resource() { std::cout << "Resource acquired\n"; }
  ~Resource() { std::cout << "Resource destroyed\n"; }
};

int main()
{
  Resource* res { new Resource };
  std::shared_ptr<Resource> ptr1{ res };     // ç›´æ¥åˆå§‹åŒ– ptr1 ï¼ˆç”¨èµ„æºç›´æ¥åˆå§‹åŒ–ï¼‰
  {
    std::shared_ptr<Resource> ptr2 { ptr1 }; // æ‹·è´åˆå§‹åŒ– ptr2 ï¼ˆå¤åˆ¶çš„å½¢å¼åˆå§‹åŒ–ï¼‰
    std::cout << "Killing one shared pointer\n";
  } // ptr2 è¶…å‡ºä½œç”¨åŸŸ
  std::cout << "Killing another shared pointer\n";
  return 0;
} // ptr1è¶…å‡ºä½œç”¨åŸŸ
#+end_src



[fn:6]
#+name: å¾ªç¯å¼•ç”¨
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory> <string>
// å¾ªç¯å¼•ç”¨å¯ä»¥æ˜¯ a -> bã€b -> aï¼Œä¹Ÿèƒ½æ˜¯ä¸‰ä¸ªå¯¹è±¡ï¼ša -> bã€b -> cã€c -> a
class Person {
  std::string m_name;
  std::shared_ptr<Person> m_partner; // æŒ‡å‘ Person çš„æŒ‡é’ˆ
public:
  Person(const std::string &name): m_name(name) { std::cout << m_name << " created\n"; }
  ~Person() { std::cout << m_name << " destroyed\n"; }
  friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2) {
    if (!p1 || !p2)
      return false;
    p1->m_partner = p2; // p1 å†…éƒ¨çš„å…±äº«æŒ‡é’ˆæŒ‡å‘ p2
    p2->m_partner = p1; // p2 å†…éƒ¨çš„å…±äº«æŒ‡é’ˆæŒ‡å‘ p1
    std::cout << p1->m_name << " is now partnered with " << p2->m_name << '\n';
    return true;
  }
};

int main() {
  auto lucy { std::make_shared<Person>("Lucy") };  // lucy æŒ‡å‘ Personç±»ï¼ˆLucyï¼‰
  auto ricky { std::make_shared<Person>("Ricky") }; // lucy æŒ‡å‘ Personç±»ï¼ˆRickyï¼‰
  partnerUp(lucy, ricky); // Lucy å’Œ Ricky äº’æŒ‡
                          // Lucy è¢«ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ï¼šlucyã€Ricky å†…éƒ¨çš„ m_partnerï¼›RickyåŒç†è¢«ä¸¤ä¸ªæŒ‡é’ˆæŒ‡
} // æ­¤æ—¶é‡Šæ”¾äº†ä¸¤ä¸ªæŒ‡é’ˆï¼šlucyã€rickyï¼›ä½† Lucy å’Œ Ricky è¿˜è¢«æŒ‡é’ˆæŒ‡å‘ï¼ˆRickyã€Lucy å†…éƒ¨çš„ m_partnerï¼‰ï¼Œå› æ­¤éƒ½ä¸ä¼šé‡Šæ”¾
#+end_src

#+name:è§£å†³ å¾ªç¯å¼•ç”¨
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory> <string>
class Person
{
  std::string m_name;
  std::weak_ptr<Person> m_partner; // å†…éƒ¨æ”¹ä¸º std::weak_ptr
public:
  Person(const std::string &name): m_name(name) { std::cout << m_name << " created\n"; }
  ~Person() { std::cout << m_name << " destroyed\n"; }
  friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2)
  {
    if (!p1 || !p2)
      return false;
    p1->m_partner = p2; // std::weak_ptr æ˜¯è§‚å¯Ÿè€…ï¼Œä¸æ˜¯æ‰€æœ‰è€…ï¼Œå› æ­¤ä¸ä¼šå¢åŠ  å¼•ç”¨è®¡æ•°
    p2->m_partner = p1;
    std::cout << p1->m_name << " is now partnered with " << p2->m_name << '\n';
    return true;
  }
};

int main()
{
  auto lucy { std::make_shared<Person>("Lucy") };
  auto ricky { std::make_shared<Person>("Ricky") };
  partnerUp(lucy, ricky);
  return 0;
} // Lucyã€Ricky æ­£å¸¸é”€æ¯
#+end_src

[fn:7]
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory> <string>
class Person {
	std::string m_name;
	std::weak_ptr<Person> m_partner; // note: This is now a std::weak_ptr
public:
	Person(const std::string &name) : m_name(name) {
		std::cout << m_name << " created\n";
	}

	~Person() {
		std::cout << m_name << " destroyed\n";
	}

	friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2) {
		if (!p1 || !p2)
			return false;

		p1->m_partner = p2;
		p2->m_partner = p1;

		std::cout << p1->m_name << " is now partnered with " << p2->m_name << '\n';

		return true;
	}
  // NOTE ä½¿ç”¨ lock() å°†  weak_ptr è½¬æ¢ä¸º shared_ptr
	std::shared_ptr<Person> getPartner() const { return m_partner.lock(); }

	const std::string& getName() const { return m_name; }
};

int main() {
	auto lucy { std::make_shared<Person>("Lucy") };
	auto ricky { std::make_shared<Person>("Ricky") };

	partnerUp(lucy, ricky);

	auto partner = ricky->getPartner(); // get shared_ptr to Ricky's partner
	std::cout << ricky->getName() << "'s partner is: " << partner->getName() << '\n';
}
#+end_src

#+RESULTS:
: Lucy created
: Ricky created
: Lucy is now partnered with Ricky
: Ricky's partner is: Lucy
: Ricky destroyed
: Lucy destroyed

[fn:8]
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
// h/t to reader Waldo for an early version of this example
class Resource {
public:
	Resource() { std::cerr << "Resource acquired\n"; }
	~Resource() { std::cerr << "Resource destroyed\n"; }
};

// Returns a std::weak_ptr to an invalid object
std::weak_ptr<Resource> getWeakPtr() {
	auto ptr{ std::make_shared<Resource>() };
	return std::weak_ptr<Resource>{ ptr };
} // ptr goes out of scope, Resource destroyed

// Returns a dumb pointer to an invalid object
Resource* getDumbPtr() {
	auto ptr{ std::make_unique<Resource>() };
	return ptr.get();
} // ptr goes out of scope, Resource destroyed

int main() {
	auto dumb{ getDumbPtr() };
	std::cout << "Our dumb ptr is: " << ((dumb == nullptr) ? "nullptr\n" : "non-null\n");

	auto weak{ getWeakPtr() };
	std::cout << "Our weak ptr is: " << ((weak.expired()) ? "expired\n" : "valid\n"); // ç”¨ expired() åˆ¤æ–­æ˜¯å¦æŒ‡å‘æ— æ•ˆå¯¹è±¡
}
#+end_src
