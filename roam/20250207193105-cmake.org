:PROPERTIES:
:ID:       c651b8b0-bc76-451d-acac-0ea55329f0e8
:END:
#+title: cmake
#+filetags: cmake

* cmake
*跨平台的构建配置工具* ，四个如下
- 配置阶段 ::
  获取：
  1. 环境信息（系统架构、编译器、链接器、存档打包器）
  2. 项目信息（根据[[id:183c9f25-d3a3-4a95-baa1-5e1a3b201a11][CMakeLists.txt]]获取）
- 生成阶段 :: 生成构建文件（Makefile、Ninja、Visual Studio）
  =cmake -B build -DCMAKE_BUILD_TYPE=XXX -DCMAKE_INSTALL_PREFIX=XXX=
- 构建阶段 :: 调用构建系统完成编译链接
  =cmake --build build -j8=
- 安装阶段 :: 将构建完的产物复制到指定位置
  =cmake --build build --target install=

打印当前系统的 cmake 相关信息： =cmake --system-information | grep <感兴趣的变量>=


* CMakeLists.txt
cmake的配置文件
|---------------------+-------------------------|
| 概念                |                         |
|---------------------+-------------------------|
| 变量 [fn:1]         | 伪目标和真实目标 [fn:2] |
| 属性传播规则 [fn:4] | 缓存生成机制[fn:3]      |
|---------------------+-------------------------|

** 模板
#+begin_src cmake
cmake_minimum_required(VERSION 3.22)  # 设置项目所需最低cmake版本

project(chat)                         # 定义 项目名称 (可指定语言、版本)，自动设置<项目名>_SOURCE_DIR等变量

set(CMAKE_CXX_STANDARD 11)            # 定义 变量、缓存变量、环境变量
set(CMAKE_CXX_STANDARD_REQUIRED ON)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

find_package(Qt5 COMPONENTS Widgets Core REQUIRED)

# FIXME file(GLOB sources *.cpp) 坑点：首次运行 CMake 配置时查找当前目录下的所有 .cpp 文件
# NOTE 可行的方式
# file (GLOB SOURCES CONFIGURE_DEPENDS *.cpp)
# file (GLOB_RECURSE SOURCES CONFIGURE_DEPENDS *.cpp)
add_executable(client                 # 生成真实目标：可执行文件
    main.cpp
    logindialog.cpp
)

target_link_libraries(client Qt5::Widgets Qt5::Core) # 为目标 链接库或目标 (作用域控制)
#+end_src

** 模板：模块化项目
#+name: 目录组织
#+begin_src bash
├── biology                     # 每新增一个功能模块，都和biology一样的目录结构
│   ├── CMakeLists.txt          # 创建库
│   ├── include
│   │   └── biology
│   │       ├── Animal.h
│   │       └── Carer.h
│   └── src
│       ├── Animal.cpp
│       └── Carer.cpp
├── cmake
│   └── MyUsefulFuncs.cmake
├── CMakeLists.txt              # 设置全局设定；通过add_subdirectory将两个子项目biology和pybmain添加进来
└── pybmain
    ├── CMakeLists.txt          # 可执行文件
    ├── include
    │   └── pybmain
    │       └── myutils.h
    └── src
        └── main.cpp
#+end_src

#+name: CMakeLists.txt
[[file:~/.org/example/cmake模块化项目/][example::cmake模块化项目]]

#+name: 代码层面
#+begin_src cpp
// 头文件（项目名/include/项目名/模块名.h）
#pragma once
namespace 项目名 {      // 避免符号冲突
    void 函数名();
}

// 实现文件（项目名/src/模块名.cpp）
#include <项目名/模块名.h>
namespace 项目名 {
    void 函数名() {
      // 函数实现
    }
}
#+end_src

** 调试/打印信息
#+begin_src cmake
message([<mode>] "message" ...)
#+end_src
*<mode>* 用于指定消息类型
|-------------+----------------------------|
| 消息类型    | 输出格式                   |
|-------------+----------------------------|
| 空          | message                    |
| STATUS      | --message                  |
| WARNING     | (黄色字体带警告) message   |
| FATAL_ERROR | (红色字体终止运行) message |
|-------------+----------------------------|

** 查找库
*** find_package
cmake *原生* 查找库的方式，具体使用见：[[https://cmake.org/cmake/help/latest/command/find_package.html#config-mode-search-procedure][find_package]]

*查找包的模式*
# 默认先 MODULE模式，后 CONFIG模式
1. CONFIG模式
包配置文件   ： =<Package>Config.cmake= / =<Package>-config.cmake=
包版本文件   ： =<Package>ConfigVersion.cmake= / =<Package>-config-version.cmake=
变量/缓存变量：
|----------------+------------|
| 变量/缓存变量  | 作用       |
|----------------+------------|
| <包名>_FOUND   | 包是否找到 |
| <包名>_DIR     | 包所在目录 |
| <包名>_VERSION | 包版本     |
|----------------+------------|
2. MODULE模式
包配置文件： =Find<Package>.cmake=

*** pkg_check_modules
cmake *调用[[id:0867edf9-0f48-48ed-92be-e197f1546b05][pkg-config]]* 查找库的方式

#+name: 使用示例
#+begin_src cmake
find_package(PkgConfig REQUIRED)
# pkg_check_modules(<prefix> [REQUIRED] <package> [<version>])
# 1. <prefix> 指定相关变量前缀，这里prefix设置为HIREDIS，因此hiredis头文件目录为HIREDIS_INCLUDE_DIRS、库文件路径为HIREDIS_LIBRARIES
# 2. <package> 库的名称，和 pkg-config 的 .pc 文件名相同
pkg_check_modules(HIREDIS REQUIRED hiredis)
...
target_include_directories(test_redis PRIVATE ${HIREDIS_INCLUDE_DIRS})
target_link_libraries(test_redis PRIVATE ${HIREDIS_LIBRARIES})
#+end_src

*** 查找没有.cmake或.pc配置文件的库
#+name: 使用示例
#+begin_src cmake
include_directories(/usr/lib)                # 包含库文件目录
file(GLOB absl_libs "/usr/lib/libabsl_*.so") # 将目录中所需的库文件存入变量
target_link_libraries(main ${absl_libs})     # 目标链接该变量
#+end_src

** 文件收集
将通配符匹配的文件存入变量
#+begin_src cmake
file(GLOB <variable> [option] <glob_pattern>)
file(GLOB_RECURSE <variable> [option] <glob_pattern>)
#+end_src
- GLOB           :: 通配符匹配文件，不递归子目录
- GLOB_RECURSE   :: 通配符匹配文件，递归子目录
- <variable>     :: 存储匹配文件路径的变量
- <glob_pattern> :: 通配符模式，通常是文件扩展名，如 **.cpp*
- option         :: 设置 =CONFIGURE_DEPENDS= 选项 ， *添加新文件会自动更新变量*

** 安装
用于复制文件到指定目录
配置阶段设置安装路径： =cmake -B build -DCMAKE_INSTALL_PREFIX=xxx= （CMAKE_INSTALL_PREFIX只控制相对路径；不控制绝对路径）

*相对路径和绝对路径*
#+begin_src cmake
# NOTE 相对路径
# 安装到 ${CMAKE_INSTALL_PREFIX}/bin/myapp
install(TARGETS myapp
  DESTINATION bin
)

# NOTE 绝对路径
# 安装到 /bin/myapp
install(TARGETS myapp
  DESTINATION /bin
)
#+end_src


* CMakeCache.txt
cmake的缓存文件，包含以下内容：
1. set设置的缓存变量，可以使用 =ccmake命令行工具= 可视化查看/编辑
2. find_package找到的库文件信息
3. 环境信息（编译器、操作系统等）


* Footnotes

[fn:1]
|----------+-------------------------------------------+-----------------------------+----------|
| 类型     | 说明                                      | 定义                        | 引用     |
|----------+-------------------------------------------+-----------------------------+----------|
| 普通变量 | 作用域是当前及子目录的 CMakeLists.txt     | set(var值)                  | ${}      |
| 缓存变量 | 写入 CMakeCache.txt；作用域是整个构建目录 | set(var值 CACHE类型 "描述") | $CACHE{} |
| 环境变量 |                                           |                             | $ENV{}   |
|----------+-------------------------------------------+-----------------------------+----------|
父模块定义的变量 *会* 传递给子模块，子模块定义的变量 *不会* 传递给父模块；
设置子传父：通过在子模块中 =set(<变量> <值> PARENT_SCOPE)=

[fn:2]
# 伪目录类似make clean这种
*伪目标* ：不生成文件，用于清理、测试、安装等辅助操作（类似make clean）
=add_custom_target=

*真实目标* ：生成可执行文件、库或输出文件，用于编译代码、链接库
=add_executable= / =add_library=

[fn:3]
缓存生成机制
1. 检测环境：cmake -B build
2. 将结果写入缓存文件[[id:045024e9-f2c8-4be5-81e0-b70661b70921][CMakeCache.txt]]，可以通过ccmake可视化查看CMakeCache.txt
3. 清理缓存：外部环境发生变化 => 删除CMakeCache.txt即可

[fn:4]
控制对目标的可见性
- PUBLIC    :: 对当前目标可见，传递给链接到此目标的其他目标
- PRIVATE   :: 对当前目标可见，不传递给链接到此目标的其他目标
- INTERFACE :: 对当前目标不可见，传递给链接到此目标的其他目标
