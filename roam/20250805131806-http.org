:PROPERTIES:
:ID:       6cd6d820-4519-4090-8b15-4b38060fe563
:END:
#+title: HTTP
#+filetags: network

* HTTP
- HTTP :: 基于 请求-响应模型 的 *无状态* 应用层协议，用于在互联网上传输超文本
  1. 半双工
  2. 端口： =80=
  3. 明文传输，简单快速，存在安全漏洞
     1) 窃听
     2) 篡改
     3) 冒充

- 无状态 :: 每个请求独立，服务器不会保留之前请求的状态信息，可通过 Cookie 实现状态管理


** HTTP报文格式（图文） :ATTACH:
:PROPERTIES:
:ID:       73835a79-dffd-45e9-bfc7-3ffa5e3850d6
:END:
[[attachment:_20260114_142621screenshot.png]]
请求报文：请求行、请求头、请求体
响应报文：响应行、响应头、响应体


** HTTP常见状态码
:PROPERTIES:
:ID:       dca5cc72-c175-4ae0-bb80-fd107cfcfb9e
:END:
|-------------------+---------------------------+------------------------------------------|
|                   | 状态码                    | 作用                                     |
|-------------------+---------------------------+------------------------------------------|
| 1xx（提示信息）   |                           |                                          |
|-------------------+---------------------------+------------------------------------------|
| 2xx（成功）       | 200 OK                    | 请求成功，响应头包含数据                 |
|                   | 201 Created               | 请求成功，在服务器上创建了新的资源       |
|                   | 204 No Content            | 请求成功，响应头没有数据                 |
|-------------------+---------------------------+------------------------------------------|
| 3xx（重定向）     | 301 Moved Permanently     | 永久重定向，资源不在，用 新URL 访问      |
|                   | 302 Found                 | 临时重定向，资源在，临时用 新URL 访问    |
|                   | 304 Not Modified          | 资源未修改（告诉客户端可以使用缓存资源） |
|-------------------+---------------------------+------------------------------------------|
| 4xx（客户端错误） | 400 Bad Request           | 请求报文有误                             |
|                   | 403 Forbidden             | 服务器禁止访问资源                       |
|                   | 404 Not Found             | 在服务器上没有找到资源                   |
|-------------------+---------------------------+------------------------------------------|
| 5xx（服务端错误） | 500 Internal Server Error | 通用错误（具体未知）                     |
|                   | 501 Not Implemented       | 功能未实现（客户端请求的）               |
|                   | 502 Bad Gateway           | 服务器作为网关/代理，访问后端服务器错误  |
|                   | 503 Service Unavailable   | 服务器很忙，无法响应客户端               |
|-------------------+---------------------------+------------------------------------------|


** HTTP/1.0、HTTP/1.1、HTTP/2.0、HTTP/3.0
:PROPERTIES:
:ID:       98a7eb31-261b-4c66-9144-cb9adb4cf455
:END:
1. HTTP/1.0 是 *短连接* ：每次 请求-响应 需要 TCP三次握手和四次挥手，效率低下

2. HTTP/1.1 引入 *长连接、管道* -> 解决了 请求队头阻塞，没解决响应队头阻塞问题，提高了性能
   - 长连接：任意一方没有提出断开连接，则保持TCP连接状态（当然，如果某个HTTP长连接超过一定时间没有交互，则服务端主动断开） =Connection字段= 改为 =Keep-Alive=
   - 管道  ： =解决了 请求队头阻塞= ，具体来说：客户端发送请求后，无需等待服务器响应，可以连续的发送请求 -> 减少整体响应时间；但 =未解决 响应队头阻塞（按顺序响应）=

3. HTTP/2.0 基于 [[id:b0b55d01-31a8-4684-b94e-880240e10f2a][HTTPS]] -> 更安全
            引入 *头部压缩、二进制格式、多路复用、服务器主动推送* 机制 -> 大幅提高性能，解决 HTTP 队头阻塞问题，但没解决 [[id:c00b5a3a-d165-4ecf-ae74-37ea9427608f][🖼 TCP层面的队头阻塞问题]]
   - 头部压缩       :: 使用 HPack算法，在客户端和服务端同时维护一张 *头信息表* ，所有字段存入该表，并生成对应索引号，后续只发索引号
   - [[id:ac2d85e8-4653-431f-865a-141e0a636825][二进制格式]]     :: 请求头、请求体 都是 二进制格式，被称为 frame，这样计算机就不用将明文转成二进制，再进行解析了，而是可以直接解析
   - [[id:2693aa5d-a574-4dfe-a22b-655af47e2698][多路复用]]       :: 一个连接中多个“流”，每个请求-响应 对应 一个流，流之间不阻塞 -> 解决HTTP队头阻塞问题（不再需要按序收发）
   - 服务器主动推送 :: 在客户端没明确请求时，主动推送客户端可能需要的资源
     #+begin_example
     客户端请求 /index.html，服务器主动推送 /style.css、/logo.png 文件
     #+end_example

4. HTTP/3.0 使用基于 UDP 的 QUIC协议 -> 实现类似TCP的可靠传输，解决了TCP层面的队头阻塞


*** 🖼 HTTP1、HTTPS、HTTP2、HTTP3 :ATTACH:
:PROPERTIES:
:ID:       29defea1-0ed5-409c-866c-2888fa05994b
:END:
[[attachment:_20250820_164535screenshot.png]]


*** 🖼 HTTP2二进制格式 :ATTACH:
:PROPERTIES:
:ID:       ac2d85e8-4653-431f-865a-141e0a636825
:END:
[[attachment:_20250820_163411screenshot.png]]


*** 🖼 HTTP2多路复用 :ATTACH:
:PROPERTIES:
:ID:       2693aa5d-a574-4dfe-a22b-655af47e2698
:END:
[[attachment:_20250820_163546screenshot.png]]


*** 🖼 TCP层面的队头阻塞问题 :ATTACH:
:PROPERTIES:
:ID:       c00b5a3a-d165-4ecf-ae74-37ea9427608f
:END:
[[attachment:_20250820_163952screenshot.png]]
*TCP队头阻塞* ：TCP层必须保证收到的字节数据是完整且连续的，否则无法从内核缓冲区返回给应用层的HTTP应用
#+begin_example
假设每次内核缓冲区读满才交给应用层的HTTP应用，但是中间有个TCP报文丢失，必须等收到了这个TCP报文才能交给HTTP应用
#+end_example


** HTTP常见字段
:PROPERTIES:
:ID:       1eebf202-e185-4834-866b-463e161d9d82
:END:
*客户端*
- Host            :: 指定 要访问的服务器的域名。eg： =Host: www.A.com=
- Connection      :: 客户端要求服务端使用 HTTP长连接 机制。eg： =Connection: Keep-Alive=
  #+begin_comment
  HTTP/1.1 默认长连接，老版本 HTTP 需要指定 Keep-Alive
  #+end_comment
- Accept          :: 接受的数据格式。eg： =Accept: */*=
- Accept-Encoding :: 接受的数据压缩方式。eg： =Accept-Encoding: gzip, deflate=

*服务端*
- Content-Length   :: 响应的数据长度。eg： =Content-Length: 1000=
- Content-Type     :: 响应的数据格式。eg： =Content-Type: text/html; Charset=utf-8=
- Content-Encoding :: 响应的数据压缩方法。eg： =Content-Encoding: gzip=
- Cache-Control    :: 相对时间（资源在客户端的有效期），优先级更高
- Expires          :: 绝对时间（资源在客户端的有效期）


** HTTP缓存机制
:PROPERTIES:
:ID:       13e0973e-0e34-4b4d-8507-036cdd98984b
:END:
1. *强缓存*
   # 浏览器自己判断是否使用资源
   浏览器第一次请求资源时，服务器返回 *资源 + Cache-Control/Expires字段* （说明资源的过期时间），
   浏览器后续请求相同资源时，会与 =Cache-Control= 进行比对，决定用缓存/重新请求服务器
   - Cache-Control :: 资源过期 相对时间，优先级更高
   - Expires       :: 资源过程 绝对时间

2. *协商缓存*
   # 浏览器和服务器协商后，判断是否使用资源
   浏览器第一次请求资源时，服务器返回 *资源 + 资源标识（Last-Modified / ETag）*
   浏览器后续请求（ *If-Modified-Since / If-None-Match* ），服务器判断 若是最新资源，返回 *304 状态码* ，直接从缓存拿资源；否则返回 *200 状态码 + 最新资源 + 新的资源标识*
   1) (请求头) If-Modified-Since：用服务器发来的 Last-Modified 的值填充
      (响应头) Last-Modified：资源上一次修改时间
   2) (请求头) If-None-Match：用服务器发来的 Etag 的值填充
      (响应头) Etag：资源对应的唯一字符串
   #+begin_comment
   优先使用 Etag
   1. Last-Modified 的值 *只精确到秒级* -> 资源修改速度在秒级以下，则无法及时更新资源
   2. 如果每隔一段时间重复生成 *内容相同* 的文件 -> Last-Modified 每次都会返回
   #+end_comment

📎 [[https://www.bilibili.com/video/BV1n54y1E7wH/?vd_source=4441bc96046659b39d059d583f36ff52][bilibili-小野WEB世界]] [[https://www.bilibili.com/video/BV1gf4y1V7CH/?spm_id_from=333.1387.upload.video_card.click&vd_source=4441bc96046659b39d059d583f36ff52][bilibili-小野WEBi世界2]]


** HTTP请求方式
:PROPERTIES:
:ID:       283de6cb-accb-40ac-bc1a-41846a282354
:END:
HTTP 定义了 客户端和服务端之间的通信方式；HTTP请求方法 表示 *对资源执行的操作*

*GET*
1. 语义：获取数据
2. 数据在URL中（键值对形式）-> 安全性不好
3. 幂等
   - 幂等 :: 多次请求，结果相同
#+begin_example
https://example.com/search?keyword=apple&category=fruit
#+end_example

*POST*
1. 语义：提交数据；常用于创建新资源
2. 数据在请求体中（可以是结构化的JSON数据且在请求体中） -> 安全性好
3. 非幂等
   - 非幂等 :: 多次请求，结果不同

*PUT*
1. 语义：更新数据
2. 幂等

*DELETE*
1. 语义：删除数据
2. 幂等

*HEAD*
1. 语义：类似 GET；但只返回响应头，不返回响应体 -> 用于检查数据是否存在或获取元数据

*PATCH*
1. 语义：对数据进行部分修改；用于局部更新
2. 非幂等

*OPTIONS*

*CONNECT*


** RESTful API
:PROPERTIES:
:ID:       7cd32dab-2444-41fa-afe7-3949c3cc7fac
:END:
- RESTful API :: 使用 [[id:6cd6d820-4519-4090-8b15-4b38060fe563][HTTP]]协议 管理资源
  1. [[id:9a6deb84-6f44-4491-b4c9-90d28c4e67de][URI]] 表示 *资源*
     #+begin_example
     /users/123/orders：表示 “ID 123 的用户名下的所有订单”（订单是用户的子资源）
     /orders/456      ：表示 “ID 456 的单个订单”（独立资源）
     #+end_example
  2. HTTP方法   表示 *对资源的操作* ：GET（获取）、POST（创建）、PUT（全量更新）、PATCH（部分更新）、DELETE（删除）
  3. HTTP状态码 表示 *操作结果*


*** URI
:PROPERTIES:
:ID:       9a6deb84-6f44-4491-b4c9-90d28c4e67de
:END:
- URI :: 统一资源标识符，用于 *标识资源* ，具体形式为： =标识符=
  1. 包含 [[id:2a600fe8-dba0-44fd-86de-4c61b8371921][URL]]（所有的URL都是URI，反之不成立）
#+begin_example
ISBN:978-3-16-148410-0            （这是一本书的URN，也是URI）
tel:+1-800-555-1234               （这是一个电话号码的URI）
urn:isbn:0451450523               （这是一个URN，也是URI）
https://www.example.com/index.html（这是一个URL，同时也是URI）
#+end_example


*** URL
:PROPERTIES:
:ID:       2a600fe8-dba0-44fd-86de-4c61b8371921
:END:
- URL :: 统一资源定位符，用于 *定位、访问资源* ，具体形式为： =访问协议（http、ftp等）+ 位置=
  1. URI 的子集
#+begin_example
https://www.example.com/index.html（协议 + 域名 + 路径）
ftp://example.com/files/file.zip  （协议 + 地址 + 路径）
#+end_example


** 键入网址到网页显示
:PROPERTIES:
:ID:       c497042a-9af7-4300-96e2-491041b92c86
:END:
1. 浏览器解析 URL -> 协议、服务器、资源路径
2. 生成 [[id:846e95b1-e15d-4277-822a-c2fa49faa90a][HTTP请求报文]]
3. 查询 [[id:36774da4-2384-4014-92e1-a77e0eea1309][DNS]]服务器 -> 域名对应IP
4. [[id:ceed6c1f-7585-4884-874d-eb2dbf4145ae][TCP三次握手]]
5. 客户端 发送 HTTP请求报文 给服务器
6. 服务器 收到后发送 HTTP响应报文（包含：html、css、js）给客户端
7. 客户端的浏览器 渲染页面
8. [[id:a9a65a40-fc21-4c71-925e-291763a06f35][TCP四次挥手]]

📎 [[https://zhuanlan.zhihu.com/p/57895541][知乎]]
