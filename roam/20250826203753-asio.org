:PROPERTIES:
:ID:       c590482b-2e5a-4617-822b-74a9dd015ae5
:END:
#+title: asio
#+filetags: boost

* asio
- asio :: è·¨å¹³å°çš„ C++å¼‚æ­¥IOåº“ï¼Œé€šè¿‡å¼‚æ­¥æ“ä½œå®ç°é«˜æ•ˆçš„ç½‘ç»œé€šä¿¡ï¼ˆé»˜è®¤ *proactoræ¨¡å¼* ï¼ŒåŒæ—¶æ”¯æŒ *reactoræ¨¡å¼* ï¼‰
  1. windowsä¸‹ï¼šé»˜è®¤åŸºäº *IOCP* å®ç° proactoræ¨¡å¼
  2. [[id:ec7aef91-2628-4ba9-b300-16652314877f][linux]]ä¸‹ï¼šèƒ½é€šè¿‡ [[id:52c4cf0a-3de5-4e9d-a314-821f6c2f39c3][epoll]] å®ç° [[id:ca075f9e-f498-4059-86f6-d62674884833][reactor]]æ¨¡å¼ï¼Œä¹Ÿèƒ½é€šè¿‡æ‰©å±•å®ç° proactoræ¨¡å¼

*æ ¸å¿ƒç»„ä»¶* ï¼š
1. io_context
2. IOå¯¹è±¡ï¼ˆegï¼šsocketã€å®šæ—¶å™¨ï¼‰
3. å¼‚æ­¥æ“ä½œï¼ˆegï¼šasync_readã€async_writeã€async_acceptç­‰ï¼‰
4. strandï¼ˆä¿è¯å›è°ƒå‡½æ•°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹åºåˆ—åŒ–è¿›è¡Œï¼‰
ç»„ä»¶åä½œçš„ç¤ºä¾‹ [fn:1]

*å¼‚æ­¥æ“ä½œåŸç†* ï¼š
åˆ›å»º io_context å¯¹è±¡ï¼Œå°† io_context ä¸ IOå¯¹è±¡å…³è”ï¼ˆegï¼šsocketï¼‰ï¼Œè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œå¼‚æ­¥æ“ä½œ ä¸­æ³¨å†Œ completion handlerï¼Œå‘èµ·å¼‚æ­¥æ“ä½œåç«‹åˆ»è¿”å›ï¼Œåç»­åŒæ­¥é˜»å¡ï¼ˆé˜»å¡æ˜¯ç­‰å¾…æ“ä½œç³»ç»ŸIOå®Œæˆé€šçŸ¥ï¼Œè€Œä¸æ˜¯ä¸»åŠ¨è½®è¯¢æ£€æŸ¥IOçŠ¶æ€ï¼‰çš„è°ƒç”¨ =boost::asio::io_context::run()= ï¼Œå†…éƒ¨ä¼šè¿è¡Œäº‹ä»¶å¾ªç¯ï¼Œå¹¶å¤„ç†äº‹ä»¶å¾ªç¯ä¸­ä»»åŠ¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚å¼‚æ­¥æ“ä½œä¸­æ³¨å†Œçš„ completion handlerï¼ˆé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ post() æˆ– dispatch() æäº¤çš„ä»»åŠ¡ã€å®šæ—¶å™¨ä»»åŠ¡ï¼‰ï¼Œç›´åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºä¼šio_contextè¢«åœæ­¢ï¼Œä¸ºäº†é˜²æ­¢io_contexté€€å‡ºï¼Œå¯ä»¥åœ¨io_contextä¸­æ·»åŠ å·¥ä½œå¯¹è±¡ï¼ˆboost::asio::executor_work_guardï¼‰ï¼›å…·ä½“è§ï¼š[[id:9058e3e8-60a2-48a3-b028-ec05ff0b3f1f][ğŸ–¼ asioå·¥ä½œæ–¹å¼ï¼ˆåŒæ­¥/å¼‚æ­¥æ¨¡å‹ï¼‰]]
- å¼‚æ­¥æ“ä½œï¼š =async_read= ã€ =async_write= ã€ =async_wait=
- completion handler :: å®Œæˆå¤„ç†å‡½æ•°
  #+begin_example cpp
  socket.async_read_some(buffer, [](error_code e, size_t) { /*å¤„ç†é€»è¾‘*/ } );
  // æ­¤ç¤ºä¾‹çš„å®Œæˆå¤„ç†å‡½æ•°æ˜¯lambda
  #+end_example
- io_context :: IOæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç”¨äºè¿æ¥ IOå¯¹è±¡ å’Œ æ“ä½œç³»ç»Ÿçš„IOæœåŠ¡
#+begin_comment é˜²æ­¢io_contexté€€å‡ºçš„åœºæ™¯
åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ¯ä¸ªçº¿ç¨‹è¿è¡Œä¸€ä¸ª io_contextï¼Œè‹¥ io_context ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œio_context ä¼šé€€å‡ºï¼Œä½†æˆ‘ä»¬å¸Œæœ› io_context å­˜æ´»
#+end_comment

ğŸ“ [[https://www.boost.org/doc/libs/latest/doc/html/boost_asio/overview/basics.html][boost::asio]]


** ğŸ–¼ asioå·¥ä½œæ–¹å¼ï¼ˆåŒæ­¥/å¼‚æ­¥æ¨¡å‹ï¼‰ :ATTACH:
:PROPERTIES:
:ID:       9058e3e8-60a2-48a3-b028-ec05ff0b3f1f
:END:
*åŒæ­¥æ¨¡å‹* ï¼š
[[attachment:_20250826_220615screenshot.png]]

*å¼‚æ­¥æ¨¡å‹* ï¼š
[[attachment:_20250826_220703screenshot.png]]
1. IOå¯¹è±¡ï¼ˆegï¼šsocketï¼‰çš„å¼‚æ­¥æ“ä½œ ä¸­æ³¨å†Œ å®Œæˆå¤„ç†å‡½æ•°ï¼ˆcompletion handlerï¼‰
   #+begin_example cpp
   socket.async_connect(server_endpoint, your_completion_handler);
   void your_completion_handler(const boost::system::error_code& ec);
   #+end_example
2. IOå¯¹è±¡ å°†è¯·æ±‚è½¬å‘ç»™ IOæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆio_contextï¼‰
3. io_context å‘æ“ä½œç³»ç»Ÿå‘å‡ºä¿¡å·ï¼ŒæŒ‡ç¤ºå…¶å¯åŠ¨å¼‚æ­¥è¿æ¥
[[attachment:_20250826_220730screenshot.png]]
4. æ“ä½œç³»ç»Ÿ å°†ç»“æœæ”¾å…¥é˜Ÿåˆ—ï¼Œç­‰å¾… io_context å–ç”¨
5. io_context::run() æ¥åŒæ­¥é˜»å¡åœ°è·å–ç»“æœ
6. è°ƒç”¨ io_context::run() æœŸé—´ï¼Œio_context ä»é˜Ÿåˆ—ä¸­å–å‡ºç»“æœï¼Œè½¬æ¢ä¸º error_codeï¼Œç„¶åä¼ é€’ç»™ æ³¨å†Œçš„ completion handler


* Footnotes

[fn:1]
#+begin_example cpp
// åˆå§‹ä¸Šä¸‹æ–‡å¯¹è±¡
asio::io_context io_context;

// åˆ›å»ºIOå¯¹è±¡ï¼Œå…³è”ä¸Šä¸‹æ–‡å¯¹è±¡
asio::ip::tcp::socket socket(io_context);
socket.connect(asio::ip::tcp::endpoint(asio::ip::address::from_string("127.0.0.1"), 8080));

// ä½¿ç”¨IOå¯¹è±¡ï¼Œå‘èµ·å¼‚æ­¥æ“ä½œï¼Œå¹¶ä¸”æ³¨å†Œå›è°ƒå‡½æ•°ï¼ˆå¼‚æ­¥æ“ä½œç»“æŸåè°ƒç”¨ï¼‰
char buffer[1024];
asio::async_read(socket, asio::buffer(buffer),
  [&](std::error_code ec, std::size_t length) {
    if (!ec) {
      // å¤„ç†è¯»å–çš„æ•°æ®
      std::cout << "Received: " << std::string(buffer, length) << std::endl;
    }
  });

// å¯åŠ¨äº‹ä»¶å¾ªç¯
io_context.run();  // é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰æ“ä½œå®Œæˆ
#+end_example
