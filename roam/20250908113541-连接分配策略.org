:PROPERTIES:
:ID:       bd74c739-0d9f-40a0-9826-83ed36c50b01
:END:
#+title: 负载均衡算法(连接、请求分配)
#+filetags: network

* 负载均衡算法(连接、请求分配)
# 节点 = 服务器
# 同构 = 服务器性能一致
# 异构 = 服务器性能存在明显差异
*轮询* ：
1. 顺序循环选择节点分配请求

*加权轮询* ：
1. 按权重顺序循环选择节点分配请求

*随机* ：
1. 随机选择节点分配请求

*加权随机* ：
1. 按权重随机选择节点分配请求（权重越高的节点被选中的概率越大）

*最小连接* ：
1. 选择连接数最小的节点分配请求

*哈希* ：
1. 对 请求标识（eg：用户ID、IP地址）计算哈希值，再哈希值对节点总数进行取模 -> 相同标识断点请求会被分配到同一个节点（实现：会话保持、数据本地化）
   #+begin_example cpp
   hash(key) % 3
   #+end_example

*一致性哈希* ：
1. 对 节点、请求标识 计算哈希值，映射到一个哈希环（对2^32进行取模）


* 一致性哈希 [[https://www.xiaolincoding.com/os/8_network_system/hash.html][小林coding]]
一种负载均衡算法，解决 节点扩容缩容时的数据迁移问题 -> 更少的数据迁移量
*一致性哈希* ：
1. 映射节点和数据： =hash(节点) % 2^32= 、 =hash(连接) % 2^32= 通过这种方式映射到 哈希环
2. 数据寻址      ： 数据顺时针方向找到的第一个节点
3. 扩容和缩容    ： 增加节点 通过 =hash(节点) % 2^32= 映射节点到哈希环中；新增/减少节点 都只会影响 该节点在哈希环上顺时针的下一个节点；见：[[id:2e8203cb-5616-41c8-b2c4-a46b57eaa9b9][图:一致性哈希扩容和缩容]]
   #+begin_comment 示例
   新增节点：下一个节点上的数据迁移到当前节点
   减少节点：当前节点上的数据迁移到下一个节点
   #+end_comment
如果节点数量少，一致性哈希存在 节点分布不均匀问题

*虚拟节点* ：用于解决 一致性哈希 节点分布不均匀问题
1. 映射虚拟节点：为每个真实节点创建多个虚拟节点，将虚拟节点映射到哈希环（不将真实节点映射到哈希环）；节点数量多了，分布就均匀了
2. 数据寻址    ：数据按顺时针先找到虚拟节点，再找到真实节点
为硬件配置更好的节点增加权重 -> 增加对应的更多虚拟节点

*带虚拟节点的一致性哈希 适用场景* ：硬件配置不同、节点规模会变化


** 图:一致性哈希扩容和缩容 :ATTACH:
:PROPERTIES:
:ID:       2e8203cb-5616-41c8-b2c4-a46b57eaa9b9
:END:
扩容：
[[attachment:_20250908_204800screenshot.png]]
缩容：
[[attachment:_20250908_204816screenshot.png]]
